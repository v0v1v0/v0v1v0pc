<div class="container">

<table style="width: 100%;"><tr>
<td>StrPBR</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Stratified Permuted Block Randomization</h2>

<h3>Description</h3>

<p>Allocates patients to one of two treatments using stratified permuted block randomization proposed by Zelen M (1974) &lt;doi:10.1016/0021-9681(74)90015-0&gt;. 
</p>


<h3>Usage</h3>

<pre><code class="language-R">StrPBR(data, bsize = 4)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>a data frame. A row of the dataframe corresponds to the covariate profile of a patient.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bsize</code></td>
<td>
<p>the block size for stratified randomization. It is required to be a multiple of 2. The default is <code>4</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Different covariate profiles are defined to be strata, and then permuted block randomization is applied to each stratum. It works efficiently when the number of strata is small. However, when the number of strata increases, the stratified permuted block randomization fails to obtain balance between two treatments.
</p>
<p>Permuted block randomization, or blocking, is used to balance treatments within a block so that there are the same number of subjects in each treatment. A block contains the same number of each treatment and blocks of different sizes are combined to make up the randomization list. 
</p>
<p>Details of the procedure can be found in Zelen M (1974).
</p>


<h3>Value</h3>

<p>It returns an object of <code>class</code> <code>"carandom"</code>. 
</p>
<p>An object of class <code>"carandom"</code> is a list containing the following components: 
</p>
<table>
<tr style="vertical-align: top;">
<td><code>datanumeric</code></td>
<td>
<p>a bool indicating whether the data is a numeric data frame.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>covariates</code></td>
<td>
<p>a character string giving the name(s) of the included covariates.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>strt_num</code></td>
<td>
<p>the number of strata.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cov_num</code></td>
<td>
<p>the number of covariates.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>level_num</code></td>
<td>
<p>a vector of level numbers for each covariate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n</code></td>
<td>
<p>the number of patients.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Cov_Assig</code></td>
<td>
<p>a <code>(cov_num + 1) * n</code> matrix containing covariate profiles for all patients and the corresponding assignments. The <code class="reqn">i</code>th column represents the <code class="reqn">i</code>th patient. The first <code>cov_num</code> rows include patients' covariate profiles, and the last row contains the assignments.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>assignments</code></td>
<td>
<p>the randomization sequence.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>All strata</code></td>
<td>
<p>a matrix containing all strata involved.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Diff</code></td>
<td>
<p>a matrix with only one column. There are final differences at the overall, within-stratum, and within-covariate-margin levels.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>a character string describing the randomization procedure to be used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Data Type</code></td>
<td>
<p>a character string giving the data type, <code>Real</code> or <code>Simulated</code>. </p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>framework</code></td>
<td>
<p>the framework of the used randomization procedure: stratified randomization, or model-based method.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>the data frame.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bsize</code></td>
<td>
<p>the block size.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>numbers of pats for each stratum</code></td>
<td>
<p>a vector giving the numbers of patients for each stratum.</p>
</td>
</tr>
</table>
<h3>References</h3>

<p>Ma W, Ye X, Tu F, Hu F. <em>carat: Covariate-Adaptive Randomization for Clinical Trials</em>[J]. Journal of Statistical Software, 2023, 107(2): 1-47.
</p>
<p>Zelen M. <em>The randomization and stratification of patients to clinical trials</em>[J]. Journal of chronic diseases, 1974, 27(7): 365-375.
</p>


<h3>See Also</h3>

<p>See <code>StrPBR.sim</code> for allocating patients with covariate data generating mechanism. 
See <code>StrPBR.ui</code> for the command-line user interface.
</p>


<h3>Examples</h3>

<pre><code class="language-R"># a simple use
## Real Data
## creat a dataframe
df &lt;- data.frame("gender" = sample(c("female", "male"), 100, TRUE, c(1 / 3, 2 / 3)), 
                 "age" = sample(c("0-30", "30-50", "&gt;50"), 100, TRUE), 
                 "jobs" = sample(c("stu.", "teac.", "others"), 100, TRUE), 
                 stringsAsFactors = TRUE)
Res &lt;- StrPBR(data = df, bsize = 4)
## view the output
Res

## view all patients' profile and assignments
Res$Cov_Assig

## Simulated data
cov_num &lt;- 3
level_num &lt;- c(2, 3, 3)
pr &lt;- c(0.4, 0.6, 0.3, 0.4, 0.3, 0.4, 0.3, 0.3)
Res.sim &lt;- StrPBR.sim(n = 100, cov_num, level_num, pr)
## view the output
Res.sim

## view the detials of difference
Res.sim$Diff


N &lt;- 5
n &lt;- 1000
cov_num &lt;- 3
level_num &lt;- c(2, 3, 5) 
# Set pr to follow two tips:
#(1) length of pr should be sum(level_num);
#(2)sum of probabilities for each margin should be 1.
pr &lt;- c(0.4, 0.6, 0.3, 0.4, 0.3, rep(0.2, times = 5))
omega &lt;- c(0.2, 0.2, rep(0.6 / cov_num, times = cov_num))
# Set block size for stratified randomization
bsize &lt;- 4

## generate a container to contain Diff
DS &lt;- matrix(NA, ncol = N, nrow = 1 + prod(level_num) + sum(level_num))
for(i in 1 : N){
  rtS &lt;- StrPBR.sim(n, cov_num, level_num, pr, bsize)
  DS[ , i] &lt;- rtS$Diff
}

## do some analysis
require(dplyr)

## analyze the overall imbalance
Ana_O &lt;- matrix(NA, nrow = 1, ncol = 3)
rownames(Ana_O) &lt;- c("Str.R")
colnames(Ana_O) &lt;- c("mean", "median", "95%quantile")
tempS &lt;- DS[1, ] %&gt;% abs
Ana_O[1, ] &lt;- c((tempS %&gt;% mean), (tempS %&gt;% median),
                (tempS %&gt;% quantile(0.95)))
## analyze the within-stratum imbalances
tempWS &lt;- DS[2 : 1 + prod(level_num), ] %&gt;% abs
Ana_W &lt;- matrix(NA, nrow = 1, ncol = 3)
rownames(Ana_W) &lt;- c("Str.R")
colnames(Ana_W) &lt;- c("mean", "median", "95%quantile")
Ana_W[1, ] = c((tempWS %&gt;% apply(1, mean) %&gt;% mean),
               (tempWS %&gt;% apply(1, median) %&gt;% mean),
               (tempWS %&gt;% apply(1, mean) %&gt;% quantile(0.95)))

## analyze the marginal imbalance
tempMS &lt;- DS[(1 + prod(level_num) + 1) : (1 + prod(level_num) + sum(level_num)), ] %&gt;% abs
Ana_M &lt;- matrix(NA, nrow = 1, ncol = 3)
rownames(Ana_M) &lt;- c("Str.R");
colnames(Ana_M) &lt;- c("mean", "median", "95%quantile")
Ana_M[1, ] = c((tempMS %&gt;% apply(1, mean) %&gt;% mean),
               (tempMS %&gt;% apply(1, median) %&gt;% mean),
               (tempMS %&gt;% apply(1, mean) %&gt;% quantile(0.95)))

AnaHP &lt;- list(Ana_O, Ana_M, Ana_W)
names(AnaHP) &lt;- c("Overall", "Marginal", "Within-stratum")

AnaHP

</code></pre>


</div>