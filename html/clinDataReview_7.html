<div class="container">

<table style="width: 100%;"><tr>
<td>annotateData</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Annotate a dataset.</h2>

<h3>Description</h3>

<p>Standard annotation variables are available via the 
parameter <code>annotType</code>. Custom dataset/variables of interest
are specified via the <code>annotDataset</code>/<code>annotVar</code> parameters.
</p>


<h3>Usage</h3>

<pre><code class="language-R">annotateData(
  data,
  dataPath = ".",
  annotations,
  subjectVar = "USUBJID",
  verbose = FALSE,
  labelVars = NULL,
  labelData = "data"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>Data.frame with input data to annotate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dataPath</code></td>
<td>
<p>String with path to the data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>annotations</code></td>
<td>
<p>Annotations (or list of those) either as a:
</p>

<ul>
<li>
<p> string with standard annotation type, among:
</p>

<ul>
<li>
<p> demographics: standard variables from the demographics data (DM or ADSL) are extracted
</p>
</li>
<li>
<p> exposed_subjects: a logical variable: <code>EXFL</code> is added to <code>data</code>,
identifying exposed subjects, i.e. subjects included in the exposure dataset (EX/ADEX)
dataset and with non empty and non missing start date ('EXSTDTC', 'STDY' or 'ASTDY')
</p>
</li>
<li>
<p> functional_groups_lab: a character variable: 'LBFCTGRP' is added to <code>data</code>
based on standard naming of the parameter code ('PARAMCD' or 'LBTESTCD' variable)
</p>
</li>
</ul>
</li>
<li>
<p> list of custom annotation, with:
</p>

<ul>
<li>
<p> (optional) annotation dataset, either:
</p>

<ul>
<li>
<p> 'dataset': String with name of the annotation dataset,
e.g. 'ex' to import data from the file: '[dataset].sas7bdat'in <code>dataPath</code>
</p>
</li>
<li>
<p> 'data': Data.frame with annotation dataset
</p>
</li>
</ul>
<p>The input <code>data</code> is used if 'data' and 'dataset' are not specified.
</p>
</li>
<li>
<p> 'vars': Either:
</p>

<ul>
<li>
<p> Character vector with variables of interest from annotation dataset.
If not specified, all variables of the dataset are considered.
</p>
</li>
<li>
<p> String with new variable name computed from <code>varFct</code>
</p>
</li>
</ul>
</li>
<li>
<p> 'varFct': (optional) Either:
</p>

<ul>
<li>
<p> function of <code>data</code> or string containing such function (e.g. 'function(data) ...')
</p>
</li>
<li>
<p> string containing manipulations from column names of <code>data</code> (e.g. 'col1 + col2')
</p>
</li>
</ul>
<p>used to create a new variable specified in <code>vars</code>.
</p>
</li>
<li>
<p> 'filters': (optional) Filters for the <strong>annotation dataset</strong>, 
see <code>filters</code> parameter of <code>filterData</code>.<br>
The annotation dataset is first filtered, before being combined to the 
input <code>data</code>, such as only the records retained in the annotation dataset
will be annotated in the output <code>data</code>. Other records will 
have missing values in the annotated variables.
</p>
</li>
<li>
<p> 'varLabel': (optional) label for new variable in case <code>varFct</code> is specified.
</p>
</li>
<li>
<p> 'varsBy': (optional) Character vector with variables used to merge input data and
the annotation dataset. If not specified:
</p>

<ul>
<li>
<p> if an external dataset (<code>dataset</code>/<code>data</code>) is specified:
<code>subjectVar</code> is used
</p>
</li>
<li>
<p> otherwise: annotation dataset and input data are merged by rows IDs
</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subjectVar</code></td>
<td>
<p>String with subject ID variable, 'USUBJID' by default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>Logical, if TRUE (FALSE by default) progress messages are printed
in the current console.
For the visualizations, progress messages during download
of subject-specific report are displayed in the browser console.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>labelVars</code></td>
<td>
<p>Named character vector containing variable labels of <code>data</code>.
This will be updated with the labels of the extra annotation variables
(in <code>attr(output, 'labelVars')</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>labelData</code></td>
<td>
<p>(optional) String with label for input <code>data</code>,
that will be included in progress messages.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>Annotated <code>data</code>.
If <code>labelVars</code> is specified, the output contains an 
extra attribute: 'labelVars'
containing updated <code>labelVars</code> (accessible via: in <code>attr(output, 'labelVars')</code>).
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(clinUtils)

data(dataADaMCDISCP01)

dataLB &lt;- dataADaMCDISCP01$ADLBC
dataDM &lt;- dataADaMCDISCP01$ADSL
dataAE &lt;- dataADaMCDISCP01$ADAE

labelVars &lt;- attr(dataADaMCDISCP01, "labelVars")

# standard annotations:
# path to dataset should be specified via: 'pathData'
## Not run: 
annotateData(dataLB, annotations = "demographics", pathData = ...)

## End(Not run)

# add all variables in annotation data (if not already available)
head(annotateData(dataLB, annotations = list(data = dataDM)), 1)

# only variables of interest
head(annotateData(dataLB, annotations = list(data = dataDM, vars = c("ARM", "ETHNIC"))), 1)

# filter annotation dataset
dataAnnotated &lt;- annotateData(dataLB, 
	annotations = list(
		data = dataDM, 
		vars = c("ARM", "ETHNIC"), 
		filters = list(var = "ARM", value = "Placebo")
	)
)
head(subset(dataAnnotated, ARM == "Placebo"), 1)
head(subset(dataAnnotated, is.na(ARM)), 1)

# worst-case scenario: add a new variable based on filtering condition
dataAE$AESEV &lt;- factor(dataAE$AESEV, levels = c('MILD', "MODERATE", "SEVERE"))
dataAEWC &lt;- annotateData(
	data = dataAE,
	annotations = list(
		vars = "WORSTINT", 
		# create new variable: 'WORSTINT' 
		# with TRUE if maximum toxicity grade per subject/test 
		# (if multiple, they are all retained)
		filters = list(
			var = "AESEV", 
			# max will take latest level in a factor 
			# (so 'MODERATE' if 'MILD'/'MODERATE' are available)
			valueFct = function(x) x[which.max(as.numeric(x))],
			varsBy = c("USUBJID", "AEDECOD"),
			keepNA = FALSE,
			varNew = "WORSTINT", 
			labelNew = "worst-case"
		)
	),
	labelVars = labelVars,
	verbose = TRUE
)
attr(dataAEWC, "labelVars")["WORSTINT"]

# add a new variable based on a combination of variables:
dataLB &lt;- annotateData(dataLB, 
	annotations = list(vars = "HILORATIO", varFct = "A1HI / A1LO")
)

# add a new variable based on extraction of a existing variable
# Note: slash should be doubled when the function is specified as text
dataLB &lt;- annotateData(dataLB, 
	annotations = list(vars = "PERIOD", varFct = "sub('.* Week (.+)', 'Week \\\\1', AVISIT)")
)

# multiple annotations:
dataAnnotated &lt;- annotateData(dataLB, 
	annotations = list(
		list(data = dataDM, vars = c("ARM", "ETHNIC")),
		list(data = dataAE, vars = c("AESEV"))
	)
)
head(dataAnnotated, 1)
</code></pre>


</div>