<div class="container">

<table style="width: 100%;"><tr>
<td>STE_external</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Estimating the Subgroup Treatment Effect (STE) in an external target population using multi-source data</h2>

<h3>Description</h3>

<p>Doubly-robust and efficient estimator for the STE in an external target population using multi-source data.
</p>


<h3>Usage</h3>

<pre><code class="language-R">STE_external(
  X,
  X_external,
  EM,
  EM_external,
  Y,
  S,
  A,
  cross_fitting = FALSE,
  replications = 10L,
  source_model = "MN.glmnet",
  source_model_args = list(),
  treatment_model_type = "separate",
  treatment_model_args = list(),
  external_model_args = list(),
  outcome_model_args = list(),
  show_progress = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>X</code></td>
<td>
<p>Data frame (or matrix) containing the covariate data in the multi-source data. It should have <code class="reqn">n</code> rows and <code class="reqn">p</code> columns. Character variables will be converted to factors.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>X_external</code></td>
<td>
<p>Data frame (or matrix) containing the covariate data in the external target population. It should have <code class="reqn">n_0</code> rows and <code class="reqn">p</code> columns. This is the external data counterpart to the <code>X</code> argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>EM</code></td>
<td>
<p>Vector of length <code class="reqn">n</code> containing the effect modifier in the multi-source data. If <code>EM</code> is a factor, it will maintain its subgroup level order; otherwise it will be converted to a factor with default level order.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>EM_external</code></td>
<td>
<p>Vector of length <code class="reqn">n_0</code> containing the effect modifier in the external data. This is the external data counterpart to the <code>EM</code> argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Y</code></td>
<td>
<p>Vector of length <code class="reqn">n</code> containing the outcome.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>S</code></td>
<td>
<p>Vector of length <code class="reqn">n</code> containing the source indicator. If <code>S</code> is a factor, it will maintain its level order; otherwise it will be converted to a factor with the default level order. The order will be carried over to the outputs and plots.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>A</code></td>
<td>
<p>Vector of length <code class="reqn">n</code> containing the binary treatment (1 for treated and 0 for untreated).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cross_fitting</code></td>
<td>
<p>Logical specifying whether sample splitting and cross fitting should be used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>replications</code></td>
<td>
<p>Integer specifying the number of sample splitting and cross fitting replications to perform, if <code>cross_fitting = TRUE</code>. The default is <code>10L</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>source_model</code></td>
<td>
<p>Character string specifying the (penalized) multinomial logistic regression for estimating the source model. It has two options: "<code>MN.glmnet</code>" (default) and "<code>MN.nnet</code>", which use <span class="pkg">glmnet</span> and <span class="pkg">nnet</span> respectively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>source_model_args</code></td>
<td>
<p>List specifying the arguments for the source model (in <span class="pkg">glmnet</span> or <span class="pkg">nnet</span>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>treatment_model_type</code></td>
<td>
<p>Character string specifying how the treatment model is estimated. Options include "<code>separate</code>" (default) and "<code>joint</code>". If "<code>separate</code>", the treatment model (i.e., <code class="reqn">P(A=1|X, S=s)</code>) is estimated by regressing <code class="reqn">A</code> on <code class="reqn">X</code> within each specific internal population <code class="reqn">S=s</code>. If "<code>joint</code>", the treatment model is estimated by regressing <code class="reqn">A</code> on <code class="reqn">X</code> and <code class="reqn">S</code> using the multi-source population.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>treatment_model_args</code></td>
<td>
<p>List specifying the arguments for the treatment model (in <span class="pkg">SuperLearner</span>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>external_model_args</code></td>
<td>
<p>List specifying the arguments for the external model (in <span class="pkg">SuperLearner</span>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>outcome_model_args</code></td>
<td>
<p>List specifying the arguments for the outcome model  (in <span class="pkg">SuperLearner</span>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>show_progress</code></td>
<td>
<p>Logical specifying whether to print a progress bar for the cross-fit replicates completed, if <code>cross_fitting = TRUE</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p><strong>Data structure:</strong>
</p>
<p>The multi-source dataset consists the outcome <code>Y</code>, source <code>S</code>, treatment <code>A</code>, covariates <code>X</code> (<code class="reqn">n \times p</code>), and effect modifier <code>EM</code> in the internal populations. The data sources can be trials, observational studies, or a combination of both.
</p>
<p>The external dataset contains only covariates <code>X_external</code> (<code class="reqn">n_0 \times p</code>) and the effect modifier <code>EM_external</code>.
</p>
<p><strong>Estimation of nuissance parameters:</strong>
</p>
<p>The following models are fit:
</p>

<ul>
<li>
<p> External model: <code class="reqn">q(X)=P(R=1|X)</code>, where <code class="reqn">R</code> takes value 1 if the subject belongs to any of the internal dataset and 0 if the subject belongs to the external dataset
</p>
</li>
<li>
<p> Propensity score model: <code class="reqn">\eta_a(X)=P(A=a|X)</code>. We perform the decomposition <code class="reqn">P(A=a|X)=\sum_{s} P(A=a|X, S=s)P(S=s|X)</code> and estimate <code class="reqn">P(A=1|X, S=s)</code> (i.e., the treatment model) and <code class="reqn">P(S=s|X)</code> (i.e., the source model).
</p>
</li>
<li>
<p> Outcome model: <code class="reqn">\mu_a(X)=E(Y|X, A=a)</code>
</p>
</li>
</ul>
<p>The models are estimated by <span class="pkg">SuperLearner</span> with the exception of the source model which is estimated by <span class="pkg">glmnet</span> or <span class="pkg">nnet</span>.
</p>
<p><strong>STE estimation:</strong>
</p>
<p>The estimator is
</p>
<p style="text-align: center;"><code class="reqn">
 \dfrac{\widehat \kappa}{N}\sum\limits_{i=1}^{N} \Bigg[ I(R_i = 0) \widehat \mu_a(X_i)
 +I(A_i = a, R_i=1) \dfrac{1-\widehat q(X_i)}{\widehat \eta_a(X_i)\widehat q(X_i)}  \Big\{ Y_i - \widehat \mu_a(X_i) \Big\} \Bigg],
</code>
</p>

<p>where <code class="reqn">N=n+n_0</code>, <code class="reqn">\widehat \kappa=\{N^{-1} \sum_{i=1}^N I(R_i=0)\}^{-1}</code>, and  and <code class="reqn">\widetilde X</code> denotes the effect modifier.
</p>
<p>The estimator is doubly robust and non-parametrically efficient. To achieve non-parametric efficiency and asymptotic normality, it requires that <code class="reqn">||\widehat \mu_a(X) -\mu_a(X)||\big\{||\widehat \eta_a(X) -\eta_a(X)||+||\widehat q(X) -q(X)||\big\}=o_p(n^{-1/2})</code>.
In addition, sample splitting and cross-fitting can be performed to avoid the Donsker class assumption.
</p>
<p>When a data source is a randomized trial, it is still recommended to estimate the propensity score for optimal efficiency.
</p>


<h3>Value</h3>

<p>An object of class "STE_external". This object is a list with the following elements:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>df_dif</code></td>
<td>
<p>A data frame containing the subgroup treatment effect (mean difference) estimates for the extenal data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>df_A0</code></td>
<td>
<p>A data frame containing the subgroup potential outcome mean estimates under A = 0 for the extenal data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>df_A1</code></td>
<td>
<p>A data frame containing the subgroup potential outcome mean estimates under A = 1 for the extenal data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fit_outcome</code></td>
<td>
<p>Fitted outcome model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fit_source</code></td>
<td>
<p>Fitted source model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fit_treatment</code></td>
<td>
<p>Fitted treatment model(s).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fit_external</code></td>
<td>
<p>Fitted external model.</p>
</td>
</tr>
</table>
<h3>References</h3>

<p>Wang, G., Levis, A., Steingrimsson, J. and Dahabreh, I. (2024) <em>Efficient estimation of subgroup treatment effects using multi-source data</em>, arXiv preprint arXiv:2402.02684.
</p>
<p>Wang, G., McGrath, S., Lian, Y. and Dahabreh, I. (2024) <em>CausalMetaR: An R package for performing causally interpretable meta-analyses</em>, arXiv preprint arXiv:2402.04341.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
se &lt;- STE_external(
  X = dat_multisource[, 2:10],
  Y = dat_multisource$Y,
  EM = dat_multisource$EM,
  S = dat_multisource$S,
  A = dat_multisource$A,
  X_external = dat_external[, 2:10],
  EM_external = dat_external$EM,
  cross_fitting = FALSE,
  source_model = "MN.nnet",
  source_model_args = list(),
  treatment_model_type = "separate",
  treatment_model_args = list(
    family = binomial(),
    SL.library = c("SL.glmnet", "SL.nnet", "SL.glm"),
    cvControl = list(V = 5L)
  ),
  external_model_args = list(
    family = binomial(),
    SL.library = c("SL.glmnet", "SL.nnet", "SL.glm"),
    cvControl = list(V = 5L)
  ),
  outcome_model_args = list(
    family = gaussian(),
    SL.library = c("SL.glmnet", "SL.nnet", "SL.glm"),
    cvControl = list(V = 5L)
  )
)


</code></pre>


</div>