<div class="container">

<table style="width: 100%;"><tr>
<td>calib_msm</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Assess the calibration of a multistate model</h2>

<h3>Description</h3>

<p>Calculates the underlying data for calibration plots of the predicted transition
probabilities from a multistate model using three methods.
</p>

<ol>
<li>
<p> BLR-IPCW: Binary logistic regression with inverse probability of censoring weights.
</p>
</li>
<li>
<p> MLR-IPCW: Multinomial logistic regression with inverse probability of censoring
weights, based on the nominal calibration  framework of van Hoorde et al. (2014, 2015)
</p>
</li>
<li>
<p> Pseudo-values: Pseudo-values estimated using the Aalen-Johansen estimator (Aalen OO, Johansen S, 1978).
</p>
</li>
</ol>
<h3>Usage</h3>

<pre><code class="language-R">calib_msm(
  data.ms,
  data.raw,
  j,
  s,
  t,
  tp.pred,
  tp.pred.plot = NULL,
  calib.type = "blr",
  curve.type = "rcs",
  rcs.nk = 3,
  loess.span = 0.75,
  loess.degree = 2,
  loess.surface = c("interpolate", "direct"),
  loess.statistics = c("approximate", "exact", "none"),
  loess.trace.hat = c("exact", "approximate"),
  loess.cell = 0.2,
  loess.iterations = 4,
  loess.iterTrace = FALSE,
  mlr.smoother.type = "sm.ps",
  mlr.ps.int = 4,
  mlr.degree = 3,
  mlr.s.df = 4,
  mlr.niknots = 4,
  weights = NULL,
  w.function = NULL,
  w.covs = NULL,
  w.landmark.type = "state",
  w.max = 10,
  w.stabilised = FALSE,
  w.max.follow = NULL,
  pv.group.vars = NULL,
  pv.n.pctls = NULL,
  pv.precalc = NULL,
  pv.ids = NULL,
  CI = FALSE,
  CI.type = "bootstrap",
  CI.R.boot = NULL,
  CI.seed = 1,
  transitions.out = NULL,
  assess.moderate = TRUE,
  assess.mean = TRUE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data.ms</code></td>
<td>
<p>Validation data in <code>msdata</code> format</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data.raw</code></td>
<td>
<p>Validation data in <code>data.frame</code> (one row per individual)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>j</code></td>
<td>
<p>Landmark state at which predictions were made</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>s</code></td>
<td>
<p>Landmark time at which predictions were made</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>t</code></td>
<td>
<p>Follow up time at which calibration is to be assessed</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tp.pred</code></td>
<td>
<p>Data frame or matrix of predicted transition probabilities at time t, if in state j at time s. There must be a separate column for the predicted transition probabilities into every state, even if these predicted transition probabilities are 0.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tp.pred.plot</code></td>
<td>
<p>Data frame or matrix of predicted risks for each possible transition over which to plot the calibration curves. Argument provided to enable user to apply bootstrapping manually.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>calib.type</code></td>
<td>
<p>Whether calibration plots are estimated using BLR-IPCW ('blr'), MLR-IPCW ('mlr') or pseudo-values ('pv')</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>curve.type</code></td>
<td>
<p>Whether calibration curves are estimated using restricted cubic splines ('rcs') or loess smoothers ('loess')</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>rcs.nk</code></td>
<td>
<p>Number of knots when curves are estimated using restricted cubic splines</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loess.span</code></td>
<td>
<p>Span when curves are estimated using loess smoothers</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loess.degree</code></td>
<td>
<p>Degree when curves are estimated. using loess smoothers</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loess.surface</code></td>
<td>
<p>see <code>loess.control</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loess.statistics</code></td>
<td>
<p>see <code>loess.control</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loess.trace.hat</code></td>
<td>
<p>see <code>loess.control</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loess.cell</code></td>
<td>
<p>see <code>loess.control</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loess.iterations</code></td>
<td>
<p>see <code>loess.control</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>loess.iterTrace</code></td>
<td>
<p>see <code>loess.control</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mlr.smoother.type</code></td>
<td>
<p>Type of smoothing applied. Takes values <code>s</code> (see <code>s</code>), <code>sm.ps</code> (see <code>sm.ps</code>) or <code>sm.os</code> (see <code>sm.os</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mlr.ps.int</code></td>
<td>
<p>the number of equally-spaced B spline intervals in the vector spline smoother (see <code>sm.ps</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mlr.degree</code></td>
<td>
<p>the degree of B-spline basis in the vector spline smoother (see <code>sm.ps</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mlr.s.df</code></td>
<td>
<p>degrees of freedom of vector spline (see <code>s</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mlr.niknots</code></td>
<td>
<p>number of interior knots (see <code>sm.os</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>
<p>Vector of inverse probability of censoring weights</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>w.function</code></td>
<td>
<p>Custom function for estimating the inverse probability of censoring weights</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>w.covs</code></td>
<td>
<p>Character vector of variable names to adjust for when calculating inverse probability of censoring weights</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>w.landmark.type</code></td>
<td>
<p>Whether weights are estimated in all individuals uncensored at time s ('all') or only in individuals uncensored and in state j at time s ('state')</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>w.max</code></td>
<td>
<p>Maximum bound for inverse probability of censoring weights</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>w.stabilised</code></td>
<td>
<p>Indicates whether inverse probability of censoring weights should be stabilised or not</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>w.max.follow</code></td>
<td>
<p>Maximum follow up for model calculating inverse probability of censoring weights. Reducing this to <code>t</code> + 1 may aid in the proportional hazards assumption being met in this model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pv.group.vars</code></td>
<td>
<p>Variables to group by before calculating pseudo-values</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pv.n.pctls</code></td>
<td>
<p>Number of percentiles of predicted risk to group by before calculating pseudo-values</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pv.precalc</code></td>
<td>
<p>Pre-calculated pseudo-values</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pv.ids</code></td>
<td>
<p>Id's of individuals to calculate pseudo-values for</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CI</code></td>
<td>
<p>Size of confidence intervals as a %</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CI.type</code></td>
<td>
<p>Method for estimating confidence interval (currently restricted to <code>bootstrap</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CI.R.boot</code></td>
<td>
<p>Number of bootstrap replicates when estimating the confidence interval for the calibration curve</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CI.seed</code></td>
<td>
<p>Seed for bootstrapping procedure</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>transitions.out</code></td>
<td>
<p>Transitions for which to calculate calibration curves. Will do all possible transitions if left as NULL.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>assess.moderate</code></td>
<td>
<p>TRUE/FALSE whether to estimate data for calibration plots</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>assess.mean</code></td>
<td>
<p>TRUE/FALSE whether to estimate mean calibration</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Extra arguments to be passed to w.function (custom function for estimating weights)</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Observed event probabilities at time <code>t</code> are estimated for predicted
transition probabilities <code>tp.pred</code> out of state <code>j</code> at time <code>s</code>.
</p>
<p><code>calib.type = 'blr'</code> estimates calibration curves using techniques for assessing
the calibration of a binary logistic regression model (Van Calster et al., 2016).
A choice between restricted cubic splines and loess smoothers for estimating the
calibration curve can be made using <code>curve.type</code>. Landmarking (van Houwelingen HC, 2007)
is applied to only assess calibration in individuals who are uncensored and in state <code>j</code> at time <code>s</code>.
Calibration can only be assessed in individuals who are also uncensored at time <code>t</code>,
which is accounted for using inverse probability of censoring weights (Hernan M, Robins J, 2020).
See method BLR-IPCW from Pate et al., (2024) for a full explanation of the approach.
</p>
<p><code>calib.type = 'mlr'</code> estimates calibration scatter plots using a technique for assessing
the calibration of multinomial logistic regression models, namely the nominal
calibration framework of van Hoorde et al. (2014, 2015). Landmarking (van Houwelingen HC, 2007)
is applied to only assess calibration in individuals who are uncensored
and in state <code>j</code> at time <code>s</code>. Calibration can only be assessed in individuals
who are also uncensored at time <code>t</code>, which is accounted for using inverse probability
of censoring weights (Hernan M, Robins J, 2020). See method BLR-IPCW from Pate et al., (2024)
for a full explanation of the approach.
</p>
<p><code>calib.type = 'pv'</code> estimates calibration curves using using pseudo-values (Andersen PK, Pohar Perme M, 2010)
calculated using the Aalen-Johansen estimator (Aalen OO, Johansen S, 1978).
Calibration curves are generated by regressing the pseudo-values on the predicted transition probabilities.
A choice between restricted cubic splines and loess smoothers for estimating the
calibration curve can be made using <code>curve.type</code>. Landmarking (van Houwelingen HC, 2007)
is applied to only assess calibration in individuals who are uncensored and in state <code>j</code> at time <code>s</code>.
The nature of pseudo-values means calibration can be assessed in all landmarked individuals,
regardless of their censoring time. See method Pseudo-value approach from Pate et al., (2024)
for a full explanation of the approach.
</p>
<p>Two datasets for the same cohort of inidividuals must be provided. Firstly, <code>data.raw</code>
must be a <code>data.frame</code> with one row per individual containing the variables for
the time until censoring (<code>dtcens</code>), and an indicator for censoring <code>dtcens.s</code>,
where (<code>dtcens.s = 1</code>) if an individual is censored at time <code>dtcens</code>, and <code>dtcens.s = 0</code>
otherwise. When an individual enters an absorbing state, this prevents censoring
from happening (i.e. dtcens.s = 0). <code>data.raw</code> must also contain the desired variables
for estimating the weights. Secondly, <code>data.ms</code> must be a dataset of class <code>msdata</code>,
generated using the <code>[mstate]</code> package. This dataset is used to apply the landmarking
and identify which state individuals are in at time <code>t</code>. While <code>data.ms</code> can be
derived from <code>data.raw</code>, it would be inefficient to do this within <code>calibmsm::calib_msm</code>
due to the bootstrapping procedure, and therefore they must be inputted seperately.
</p>
<p>Unless the user specifies the weights using <code>weights</code>, the weights are
estimated using a cox-proportional hazard model, assuming a linear
functional form of the variables defined in <code>w.covs</code>. We urge users to
specify their own model for estimating the weights. The <code>weights</code> argument
must be a vector with length equal to the number of rows of <code>data.raw</code>.
</p>
<p>Confidence intervals cannot be produced for the calibration scatter plots (<code>calib.type = 'mlr'</code>).
For calibration curves estimated using <code>calib.type = 'blr'</code>, confidence intervals
can only be estimated using bootstrapping (<code style="white-space: pre;">⁠CI.type = 'bootstrap⁠</code>). This procedure uses the internal method for
estimating weights, we therefore encourage users to specify their own bootstrapping
procedure, which incorporates their own model for estimating the weights. Details
on how to do this are provided in the vignette <em>BLR-IPCW-manual-bootstrap</em>.
For calibration curves estimated using <code>calib.type = 'pv'</code>, confidence intervals
can be estimated using bootstrapping (<code style="white-space: pre;">⁠CI.type = 'bootstrap⁠</code>) or parametric formulae (<code style="white-space: pre;">⁠CI.type = 'parametric⁠</code>).
For computational reasons we recommend using the parametric approach.
</p>
<p>The calibration plots can be plotted using <code>plot.calib_msm</code> and <code>plot.calib_mlr</code>.
</p>


<h3>Value</h3>

<p><code>calib_msm</code> returns a list containing two elements:
<code>plotdata</code> and <code>metadata</code>. The <code>plotdata</code> element contains the
data for the calibration plots. This will itself be a list with each element
containing calibration plot data for the transition probabilities into each of the possible
states. Each list element contains patient ids (<code>id</code>) from <code>data.raw</code>, the predicted
transition probabilities (<code>pred</code>) and the estimated observed event
probabilities (<code>obs</code>). If a confidence interval is requested, upper (<code>obs.upper</code>)
and lower (<code>obs.lower</code>) bounds for the observed event probabilities are also returned.
If tp.pred.plot is specified, column (<code>id</code>) is not returned.
The <code>metadata</code> element contains metadata including: a vector of the possible transitions,
a vector of which transitions calibration curves have been estimated for, the
size of the confidence interval, the method for estimating the calibration curve
and other user specified information.
</p>


<h3>References</h3>

<p>Aalen OO, Johansen S. An Empirical Transition Matrix for Non-Homogeneous Markov Chains Based on Censored Observations.
<em>Scand J Stat</em>. 1978;5(3):141-150.
</p>
<p>Andersen PK, Pohar Perme M. Pseudo-observations in survival analysis.
<em>Stat Methods Med Res</em>. 2010;19(1):71-99. doi:10.1177/0962280209105020
</p>
<p>Hernan M, Robins J (2020). “12.2 Estimating IP weights via modeling.” In <em>Causal Inference:
What If</em>, chapter 12.2. Chapman Hall/CRC, Boca Raton.
</p>
<p>Pate, A., Sperrin, M., Riley, R. D., Peek, N., Van Staa, T., Sergeant, J. C., Mamas, M. A.,
Lip, G. Y. H., Flaherty, M. O., Barrowman, M., Buchan, I., &amp; Martin, G. P.
Calibration plots for multistate risk predictions models.
<em>Statistics in Medicine</em>. 2024;April:1–23. doi: 10.1002/sim.10094.
</p>
<p>Van Calster B, Nieboer D, Vergouwe Y, De Cock B, Pencina MJ, Steyerberg EW (2016). “A
calibration hierarchy for risk models was defined: From utopia to empirical data.” <em>Journal
of Clinical Epidemiology</em>, 74, 167–176. ISSN 18785921. doi:10.1016/j.jclinepi.2015.
12.005. URL http://dx.doi.org/10.1016/j.jclinepi.2015.12.005
</p>
<p>Van Hoorde K, Vergouwe Y, Timmerman D, Van Huffel S, Steyerberg W, Van Calster B
(2014). “Assessing calibration of multinomial risk prediction models.” <em>Statistics in Medicine</em>,
33(15), 2585–2596. doi:10.1002/sim.6114.
</p>
<p>Van Hoorde K, Van Huffel S, Timmerman D, Bourne T, Van Calster B (2015).
“A spline-based tool to assess and visualize the calibration of multiclass risk predictions.”
<em>Journal of Biomedical Informatics</em>, 54, 283–293. ISSN 15320464. doi:10.1016/j.jbi.2014.12.016.
URL http://dx.doi.org/10.1016/j.jbi.2014.12.016.
</p>
<p>van Houwelingen HC (2007). “Dynamic Prediction by Landmarking in Event History Analysis.”
<em>Scandinavian Journal of Statistics</em>, 34(1), 70–85.
</p>
<p>Yee TW (2015). <em>Vector Generalized Linear and Additive Models</em>. 1 edition.
Springer New, NY. ISBN 978-1-4939-4198-8. doi:10.1007/978-1-4939-2818-7.
URL https://link.springer.com/book/10.1007/978-1-4939-2818-7.
</p>


<h3>Examples</h3>

<pre><code class="language-R"># Estimate BLR-IPCW calibration curves for the predicted transition
# probabilities at time t = 1826, when predictions were made at time
# s = 0 in state j = 1. These predicted transition probabilities are stored in tps0.

# Extract the predicted transition probabilities out of state j = 1
tp.pred &lt;- dplyr::select(dplyr::filter(tps0, j == 1), any_of(paste("pstate", 1:6, sep = "")))

# Now estimate the observed event probabilities for each possible transition.
dat.calib &lt;-
calib_msm(data.ms = msebmtcal,
 data.raw = ebmtcal,
 j=1,
 s=0,
 t = 1826,
 tp.pred = tp.pred,
 w.covs = c("year", "agecl", "proph", "match"))

# Summarise the output
summary(dat.calib)

</code></pre>


</div>