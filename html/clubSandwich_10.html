<div class="container">

<table style="width: 100%;"><tr>
<td>impute_covariance_matrix</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Impute a block-diagonal covariance matrix</h2>

<h3>Description</h3>

<p>'r lifecycle::badge("superseded")'
</p>
<p>This function is superseded by the <code>vcalc</code> provided by
the <code>metafor</code> package. Compared to <code>impute_covariance_matrix</code>,
<code>vcalc</code> provides many further features, includes a
<code>data</code> argument, and uses syntax that is consistent with other
functions in <code>metafor</code>.
</p>
<p><code>impute_covariance_matrix</code> calculates a block-diagonal covariance
matrix, given the marginal variances, the block structure, and an assumed
correlation structure. Can be used to create compound-symmetric structures,
AR(1) auto-correlated structures, or combinations thereof.
</p>


<h3>Usage</h3>

<pre><code class="language-R">impute_covariance_matrix(
  vi,
  cluster,
  r,
  ti,
  ar1,
  smooth_vi = FALSE,
  subgroup = NULL,
  return_list = identical(as.factor(cluster), sort(as.factor(cluster))),
  check_PD = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>vi</code></td>
<td>
<p>Vector of variances</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cluster</code></td>
<td>
<p>Vector indicating which effects belong to the same cluster.
Effects with the same value of 'cluster' will be treated as correlated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>r</code></td>
<td>
<p>Vector or numeric value of assumed constant correlation(s) between
effect size estimates from each study.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ti</code></td>
<td>
<p>Vector of time-points describing temporal spacing of effects, for
use with auto-regressive correlation structures.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ar1</code></td>
<td>
<p>Vector or numeric value of assumed AR(1) auto-correlation(s)
between effect size estimates from each study. If specified, then <code>ti</code>
argument must be specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>smooth_vi</code></td>
<td>
<p>Logical indicating whether to smooth the marginal variances
by taking the average <code>vi</code> within each cluster. Defaults to
<code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subgroup</code></td>
<td>
<p>Vector of category labels describing sub-groups of effects.
If non-null, effects that share the same category label and the same
cluster will be treated as correlated, but effects with different category
labels will be treated as uncorrelated, even if they come from the same
cluster.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>return_list</code></td>
<td>
<p>Optional logical indicating whether to return a list of
matrices (with one entry per block) or the full variance-covariance matrix.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>check_PD</code></td>
<td>
<p>Optional logical indicating whether to check whether each
covariance matrix is positive definite. If <code>TRUE</code> (the default), the
function will display a warning if any covariance matrix is not positive
definite.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>A block-diagonal variance-covariance matrix (possibly represented as
a list of matrices) with a specified structure. The structure depends on
whether the <code>r</code> argument, <code>ar1</code> argument, or both arguments are
specified. Let <code class="reqn">v_{ij}</code> denote the specified variance for effect
<code class="reqn">i</code> in cluster <code class="reqn">j</code> and <code class="reqn">C_{hij}</code> be the covariance
between effects <code class="reqn">h</code> and <code class="reqn">i</code> in cluster
<code class="reqn">j</code>. 
</p>
 
<ul>
<li>
<p>If only <code>r</code> is specified, each block of the variance-covariance 
matrix will have a constant (compound symmetric) correlation, so that 
</p>
<p style="text-align: center;"><code class="reqn">C_{hij} = r_j \sqrt{v_{hj} v_{ij},}</code>
</p>
 
<p>where <code class="reqn">r_j</code> is the specified correlation
for cluster <code class="reqn">j</code>. If only a single value is given in <code>r</code>, then
it will be used for every cluster. 
</p>
</li>
<li>
<p>If only <code>ar1</code> is specified, each block of the variance-covariance matrix will have an
AR(1) auto-correlation structure, so that 
</p>
<p style="text-align: center;"><code class="reqn">C_{hij} = \phi_j^{|t_{hj}- t_{ij}|} \sqrt{v_{hj} v_{ij},}</code>
</p>
 
<p>where <code class="reqn">\phi_j</code> is the specified auto-correlation
for cluster <code class="reqn">j</code> and <code class="reqn">t_{hj}</code> and <code class="reqn">t_{ij}</code>
are specified time-points corresponding to effects <code class="reqn">h</code> and
<code class="reqn">i</code> in cluster <code class="reqn">j</code>. If only a single value is given in
<code>ar1</code>, then it will be used for every cluster. 
</p>
</li>
<li>
<p>If both <code>r</code> and <code>ar1</code> are specified, each block of the variance-covariance matrix will have combination of compound symmetric and an AR(1)
auto-correlation structures, so that 
</p>
<p style="text-align: center;"><code class="reqn">C_{hij} = \left[r_j + (1 - r_j)\phi_j^{|t_{hj} - t_{ij}|}\right] \sqrt{v_{hj} v_{ij},}</code>
</p>
 
<p>where <code class="reqn">r_j</code> is the specified constant correlation for cluster
<code class="reqn">j</code>, <code class="reqn">\phi_j</code> is the specified auto-correlation for
cluster <code class="reqn">j</code> and <code class="reqn">t_{hj}</code> and <code class="reqn">t_{ij}</code> are
specified time-points corresponding to effects <code class="reqn">h</code> and
<code class="reqn">i</code> in cluster <code class="reqn">j</code>. If only single values are given in
<code>r</code> or <code>ar1</code>, they will be used for every cluster. 
</p>
</li>
</ul>
<p>If <code>smooth_vi = TRUE</code>, then all of the variances within cluster
<code class="reqn">j</code> will be set equal to the average variance of cluster
<code class="reqn">j</code>, i.e., </p>
<p style="text-align: center;"><code class="reqn">v'_{ij} = \frac{1}{n_j} \sum_{i=1}^{n_j}
  v_{ij}</code>
</p>
<p> for
<code class="reqn">i=1,...,n_j</code> and <code class="reqn">j=1,...,k</code>.
</p>


<h3>Value</h3>

<p>If <code>cluster</code> is appropriately sorted, then a list of matrices,
with one entry per cluster, will be returned by default. If <code>cluster</code>
is out of order, then the full variance-covariance matrix will be returned
by default. The output structure can be controlled with the optional
<code>return_list</code> argument.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
if (requireNamespace("metafor", quietly = TRUE)) {

library(metafor)

# Constant correlation
data(SATcoaching)
V_list &lt;- impute_covariance_matrix(vi = SATcoaching$V, cluster = SATcoaching$study, r = 0.66)
MVFE &lt;- rma.mv(d ~ 0 + test, V = V_list, data = SATcoaching)
conf_int(MVFE, vcov = "CR2", cluster = SATcoaching$study)

}

</code></pre>


</div>