<div class="container">

<table style="width: 100%;"><tr>
<td>valProbggplot</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Calibration performance: ggplot version</h2>

<h3>Description</h3>

<p>The function <code>valProbggplot</code> is an adaptation of <code>val.prob</code> from Frank Harrell's rms package,
<a href="https://cran.r-project.org/package=rms">https://cran.r-project.org/package=rms</a>. Hence, the description of some of the functions of <code>valProbggplot</code>
come from the the original <code>val.prob</code>.
<br><br> The key feature of <code>valProbggplot</code> is the generation of logistic and flexible calibration curves and related statistics.
When using this code, please cite: Van Calster, B., Nieboer, D., Vergouwe, Y., De Cock, B., Pencina, M.J., Steyerberg,
E.W. (2016). A calibration hierarchy for risk models was defined: from utopia to empirical data. <em>Journal of Clinical Epidemiology</em>,
<b>74</b>, pp. 167-176
</p>


<h3>Usage</h3>

<pre><code class="language-R">valProbggplot(
  p,
  y,
  logit,
  group,
  weights = rep(1, length(y)),
  normwt = FALSE,
  pl = TRUE,
  smooth = c("loess", "rcs", "none"),
  CL.smooth = "fill",
  CL.BT = FALSE,
  lty.smooth = 1,
  col.smooth = "black",
  lwd.smooth = 1,
  nr.knots = 5,
  logistic.cal = FALSE,
  lty.log = 1,
  col.log = "black",
  lwd.log = 1,
  xlab = "Predicted probability",
  ylab = "Observed proportion",
  xlim = c(-0.02, 1),
  ylim = c(-0.15, 1),
  m,
  g,
  cuts,
  emax.lim = c(0, 1),
  legendloc = c(0.5, 0.27),
  statloc = c(0, 0.85),
  dostats = TRUE,
  cl.level = 0.95,
  method.ci = "pepe",
  roundstats = 2,
  riskdist = "predicted",
  size = 3,
  size.leg = 5,
  connect.group = FALSE,
  connect.smooth = TRUE,
  g.group = 4,
  evaluate = 100,
  nmin = 0,
  d0lab = "0",
  d1lab = "1",
  size.d01 = 5,
  dist.label = 0.01,
  line.bins = -0.05,
  dist.label2 = 0.04,
  cutoff,
  length.seg = 0.85,
  lty.ideal = 1,
  col.ideal = "red",
  lwd.ideal = 1,
  allowPerfectPredictions = FALSE,
  argzLoess = alist(degree = 2)
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>p</code></td>
<td>

<p>predicted probability
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y</code></td>
<td>

<p>vector of binary outcomes
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>logit</code></td>
<td>

<p>predicted log odds of outcome.  Specify either <code>p</code> or <code>logit</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>group</code></td>
<td>

<p>a grouping variable.  If numeric this variable is grouped into
<code>g.group</code> quantile groups (default is quartiles).  Set <code>group=TRUE</code> to
use the <code>group</code> algorithm but with a single stratum for <code>val.prob</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>

<p>an optional numeric vector of per-observation weights (usually frequencies),
used only if <code>group</code> is given.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>normwt</code></td>
<td>

<p>set to <code>TRUE</code> to make <code>weights</code> sum to the number of non-missing observations.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pl</code></td>
<td>
<p><code>TRUE</code> to plot the calibration curve(s). If <code>FALSE</code> no calibration curves will be plotted,
but statistics will still be computed and outputted.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>smooth</code></td>
<td>
<p><code>"loess"</code> generates a flexible calibration curve based on <code>loess</code>,
<code>"rcs"</code> generates a calibration curves based on restricted cubic splines (see <code>rcs</code> and
<code>rcspline.plot</code>), <code>"none"</code> suppresses the flexible curve. We recommend to use loess unless N is large,
for example N&gt;5000. Default is <code>"loess"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CL.smooth</code></td>
<td>
<p><code>"fill"</code> shows pointwise 95% confidence limits for the flexible calibration curve with a gray
area between the lower and upper limits, <code>TRUE</code> shows pointwise 95% confidence limits for the flexible calibration curve
with dashed lines, <code>FALSE</code> suppresses the confidence limits. Default is <code>"fill"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CL.BT</code></td>
<td>
<p><code>TRUE</code> uses confidence limits based on 2000 bootstrap samples, <code>FALSE</code> uses closed form confidence limits.
Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lty.smooth</code></td>
<td>
<p>the linetype of the flexible calibration curve. Default is <code>1</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>col.smooth</code></td>
<td>
<p>the color of the flexible calibration curve. Default is <code>"black"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lwd.smooth</code></td>
<td>
<p>the line width of the flexible calibration curve. Default is <code>1</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nr.knots</code></td>
<td>
<p>specifies the number of knots for rcs-based calibration curve. The default as well as the highest allowed value is 5.
In case the specified number of knots leads to estimation problems, then the number of knots is automatically reduced to the closest
value without estimation problems.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>logistic.cal</code></td>
<td>
<p><code>TRUE</code> plots the logistic calibration curve, <code>FALSE</code> suppresses this curve. Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lty.log</code></td>
<td>
<p>if <code>logistic.cal=TRUE</code>, the linetype of the logistic calibration curve. Default is <code>1</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>col.log</code></td>
<td>
<p>if <code>logistic.cal=TRUE</code>, the color of the logistic calibration curve. Default is <code>"black"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lwd.log</code></td>
<td>
<p>if <code>logistic.cal=TRUE</code>, the line width of the logistic calibration curve. Default is <code>1</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xlab</code></td>
<td>
<p>x-axis label, default is <code>"Predicted Probability"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ylab</code></td>
<td>
<p>y-axis label, default is <code>"Observed proportion"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xlim, ylim</code></td>
<td>
<p>numeric vectors of length 2, giving the x and y coordinates ranges (see <code>xlim</code> and <code>ylim</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>m</code></td>
<td>

<p>If grouped proportions are desired, average no. observations per group
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>g</code></td>
<td>

<p>If grouped proportions are desired, number of quantile groups
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cuts</code></td>
<td>

<p>If grouped proportions are desired, actual cut points for constructing
intervals, e.g. <code>c(0,.1,.8,.9,1)</code> or <code>seq(0,1,by=.2)</code>
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>emax.lim</code></td>
<td>

<p>Vector containing lowest and highest predicted probability over which to
compute <code>Emax</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>legendloc</code></td>
<td>
<p>if <code>pl=TRUE</code>, list with components <code>x,y</code> or vector <code>c(x,y)</code> for bottom right corner of legend for
curves and points. Default is <code>c(.50, .27)</code> scaled to lim. Use <code>locator(1)</code> to use the mouse, <code>FALSE</code> to suppress legend.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>statloc</code></td>
<td>
<p>the "abc" of model performance (Steyerberg et al., 2011)-calibration intercept, calibration slope,
and c statistic-will be added to the plot, using statloc as the upper left corner of a box (default is c(0,.85).
You can specify a list or a vector. Use locator(1) for the mouse, <code>FALSE</code> to suppress statistics. This is plotted after
the curve legends.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dostats</code></td>
<td>
<p>specifies whether and which performance measures are shown in the figure.
<code>TRUE</code> shows the <code>"abc"</code> of model performance (Steyerberg et al., 2011): calibration intercept, calibration slope,
and c-statistic. <code>TRUE</code> is default.
<code>FALSE</code> suppresses the presentation of statistics in the figure. A <code>c()</code> list of specific stats shows the specified
stats. The key stats which are also mentioned in this paper are <code>"C (ROC)"</code> for the c statistic, <code>"Intercept"</code> for the
calibration intercept, <code>"Slope"</code> for the calibration slope, and <code>"ECI"</code> for the estimated calibration index
(Van Hoorde et al, 2015). The full list of possible statistics is taken from <code>val.prob</code>
and augmented with the estimated calibration index: <code>"Dxy", "C (ROC)", "R2", "D", "D:Chi-sq", "D:p", "U", "U:Chi-sq",
  "U:p", "Q", "Brier", "Intercept", "Slope", "Emax", "Brier scaled", "Eavg", "ECI"</code>. These statistics are always returned by the function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cl.level</code></td>
<td>
<p>if <code>dostats=TRUE</code>, the confidence level for the calculation of the confidence intervals of the calibration intercept,
calibration slope and c-statistic. Default is <code>0.95</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method.ci</code></td>
<td>
<p>method to calculate the confidence interval of the c-statistic. The argument is passed to <code>auc.nonpara.mw</code> from
the auRoc-package and possible methods to compute the confidence interval are <code>"newcombe"</code>, <code>"pepe"</code>, <code>"delong"</code> or
<code>"jackknife"</code>. Bootstrap-based methods are not available. The default method is <code>"pepe"</code> and here, the confidence interval is
the logit-transformation-based confidence interval as documented in Qin and Hotilovac (2008). See <code>auc.nonpara.mw</code> for
more information on the other methods.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>roundstats</code></td>
<td>
<p>specifies the number of decimals to which the statistics are rounded when shown in the plot. Default is 2.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>riskdist</code></td>
<td>

<p>Use <code>"calibrated"</code> to plot the relative frequency distribution of
calibrated probabilities after dividing into 101 bins from <code>lim[1]</code> to
<code>lim[2]</code>.
Set to <code>"predicted"</code> (the default as of rms 4.5-1) to use raw assigned risk, <code>FALSE</code> to omit risk distribution.
Values are scaled so that highest bar is <code>0.15*(lim[2]-lim[1])</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>size, size.leg</code></td>
<td>
<p>controls the font size of the statistics (<code>size</code>) or plot legend (<code>size.leg</code>). Default is 3 and 5, respectively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>connect.group</code></td>
<td>

<p>Defaults to <code>FALSE</code> to only represent group fractions as triangles.
Set to <code>TRUE</code> to also connect with a solid line.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>connect.smooth</code></td>
<td>
<p>Defaults to <code>TRUE</code> to draw smoothed estimates using a line. Set to <code>FALSE</code> to instead use dots at individual estimates</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>g.group</code></td>
<td>

<p>number of quantile groups to use when <code>group</code> is given and variable is
numeric.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>evaluate</code></td>
<td>

<p>number of points at which to store the <code>lowess</code>-calibration curve.
Default is 100.  If there are more than <code>evaluate</code> unique predicted
probabilities, <code>evaluate</code> equally-spaced quantiles of the unique
predicted probabilities, with linearly interpolated calibrated values,
are retained for plotting (and stored in the object returned by
<code>val.prob</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nmin</code></td>
<td>

<p>applies when <code>group</code> is given.  When <code>nmin</code> <code class="reqn">&gt; 0</code>, <code>val.prob</code> will not
store coordinates of smoothed calibration curves in the outer tails,
where there are fewer than <code>nmin</code> raw observations represented in
those tails.  If for example <code>nmin</code>=50, the <code>plot</code> function will only
plot the estimated calibration curve from <code class="reqn">a</code> to <code class="reqn">b</code>, where there are
50 subjects with predicted probabilities <code class="reqn">&lt; a</code> and <code class="reqn">&gt; b</code>.
<code>nmin</code> is ignored when computing accuracy statistics.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>d0lab, d1lab</code></td>
<td>
<p>controls the labels for events and non-events (i.e. outcome y) for the histograms.
Defaults are <code>d1lab="1"</code> for events and <code>d0lab="0"</code> for non-events.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>size.d01</code></td>
<td>
<p>controls the size of the labels for events and non-events. Default is 5.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dist.label</code></td>
<td>
<p>controls the horizontal position of the labels for events and non-events. Default is 0.01.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>line.bins</code></td>
<td>
<p>controls the horizontal (y-axis) position of the histograms. Default is -0.05.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dist.label2</code></td>
<td>
<p>controls the vertical distance between the labels for events and non-events. Default is 0.03.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cutoff</code></td>
<td>
<p>puts an arrow at the specified risk cut-off(s). Default is none.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>length.seg</code></td>
<td>
<p>controls the length of the histogram lines. Default is <code>0.85</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lty.ideal</code></td>
<td>
<p>linetype of the ideal line. Default is <code>1</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>col.ideal</code></td>
<td>
<p>controls the color of the ideal line on the plot. Default is <code>"red"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lwd.ideal</code></td>
<td>
<p>controls the line width of the ideal line on the plot. Default is <code>1</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>allowPerfectPredictions</code></td>
<td>
<p>Logical, indicates whether perfect predictions (i.e. values of either 0 or 1) are allowed. Default is <code>FALSE</code>, since we transform
the predictions using the logit transformation to calculate the calibration measures. In case of 0 and 1, this results in minus infinity and infinity, respectively. if
<code>allowPerfectPredictions = TRUE</code>, 0 and 1 are replaced by 1e-8 and 1 - 1e-8, respectively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>argzLoess</code></td>
<td>
<p>a list with arguments passed to the <code>loess</code> function</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>When using the predicted probabilities of an uninformative model (i.e. equal probabilities for all observations), the model has no predictive value.
Consequently, where applicable, the value of the performance measure corresponds to the worst possible theoretical value. For the ECI, for example, this equals 1 (Edlinger et al., 2022).
</p>


<h3>Value</h3>

<p>An object of type <code>ggplotCalibrationCurve</code> with the following slots:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>call</code></td>
<td>
<p>the matched call.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ggPlot</code></td>
<td>
<p>the ggplot object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>stats</code></td>
<td>
<p>a vector containing performance measures of calibration.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cl.level</code></td>
<td>
<p>the confidence level used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Calibration</code></td>
<td>
<p>contains the calibration intercept and slope, together with their confidence intervals.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Cindex</code></td>
<td>
<p>the value of the c-statistic, together with its confidence interval.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>warningMessages</code></td>
<td>
<p>if any, the warning messages that were printed while running the function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>CalibrationCurves</code></td>
<td>
<p>The coordinates for plotting the calibration curves. </p>
</td>
</tr>
</table>
<h3>Note</h3>

<p>In order to make use (of the functions) of the package auRoc, the user needs to install JAGS. However, since our package only uses the
<code>auc.nonpara.mw</code> function which does not depend on the use of JAGS, we therefore copied the code and slightly adjusted it when
<code>method="pepe"</code>.
</p>


<h3>References</h3>

<p>Edlinger, M, van Smeden, M, Alber, HF, Wanitschek, M, Van Calster, B. (2022). Risk prediction models for discrete ordinal outcomes: Calibration and the impact of the proportional odds assumption. <em>Statistics in Medicine</em>, <b>41( 8)</b>, pp. 1334– 1360
</p>
<p>Qin, G., &amp; Hotilovac, L. (2008). Comparison of non-parametric confidence intervals for the area under the ROC curve of a continuous-scale diagnostic test. <em>Statistical Methods in Medical Research</em>, <b>17(2)</b>, pp. 207-21
</p>
<p>Steyerberg, E.W., Van Calster, B., Pencina, M.J. (2011). Performance measures for prediction models and markers : evaluation of predictions and classifications. <em>Revista Espanola de Cardiologia</em>, <b>64(9)</b>, pp. 788-794
</p>
<p>Van Calster, B., Nieboer, D., Vergouwe, Y., De Cock, B., Pencina M., Steyerberg E.W. (2016). A calibration hierarchy for risk models was defined: from utopia to empirical data. <em>Journal of Clinical Epidemiology</em>, <b>74</b>, pp. 167-176
</p>
<p>Van Hoorde, K., Van Huffel, S., Timmerman, D., Bourne, T., Van Calster, B. (2015). A spline-based tool to assess and visualize the calibration of multiclass risk predictions. <em>Journal of Biomedical Informatics</em>, <b>54</b>, pp. 283-93
</p>


<h3>Examples</h3>

<pre><code class="language-R">
# Load package
library(CalibrationCurves)
set.seed(1783)

# Simulate training data
X      = replicate(4, rnorm(5e2))
p0true = binomial()$linkinv(cbind(1, X) %*% c(0.1, 0.5, 1.2, -0.75, 0.8))
y      = rbinom(5e2, 1, p0true)
Df     = data.frame(y, X)

# Fit logistic model
FitLog = lrm(y ~ ., Df)

# Simulate validation data
Xval   = replicate(4, rnorm(5e2))
p0true = binomial()$linkinv(cbind(1, Xval) %*% c(0.1, 0.5, 1.2, -0.75, 0.8))
yval   = rbinom(5e2, 1, p0true)
Pred   = binomial()$linkinv(cbind(1, Xval) %*% coef(FitLog))

# Default calibration plot
valProbggplot(Pred, yval)

# Adding logistic calibration curves and other additional features
valProbggplot(Pred, yval, CL.smooth = TRUE, logistic.cal = TRUE, lty.log = 2,
 col.log = "red", lwd.log = 1.5)

valProbggplot(Pred, yval, CL.smooth = TRUE, logistic.cal = TRUE, lty.log = 9,
col.log = "red", lwd.log = 1.5, col.ideal = colors()[10], lwd.ideal = 0.5)
</code></pre>


</div>