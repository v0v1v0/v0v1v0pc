<div class="container">

<table style="width: 100%;"><tr>
<td>CausalMBSTS</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Causal effect estimation in a multivariate setting</h2>

<h3>Description</h3>

<p>The function estimates the general effect of an intervention in a multivariate time series
setting. It uses MCMC to sample from the joint posterior distribution of the parameters
of an MBSTS model before the intervention/treatment occurred. Then, it uses the
post-intervention covariate values to predict the counterfactual potential outcomes.
The prediction is done by sampling from the posterior predictive
distribution (PPD). Then the causal effect is computed by taking the difference between
the observed outcome of each time series and the mean of the PPD (credible intervals are
computed accordingly).
</p>


<h3>Usage</h3>

<pre><code class="language-R">CausalMBSTS(
  y,
  components,
  seas.period = NULL,
  cycle.period = NULL,
  X = NULL,
  dates,
  int.date,
  alpha = 0.05,
  excl.dates = NULL,
  horizon = NULL,
  H = NULL,
  nu0.r = NULL,
  s0.r,
  nu0.eps = NULL,
  s0.eps,
  niter,
  burn = NULL,
  ping = NULL
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>y</code></td>
<td>
<p>t x d data.frame (or matrix) of observations, where d is the number
of time series in the multivariate model.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>components</code></td>
<td>
<p>Character vector specifying the components of the
multivariate structural time series model. Possible values are c("trend",
"slope", "seasonal", "cycle").</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>seas.period</code></td>
<td>
<p>Length of the seasonal pattern, if present.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cycle.period</code></td>
<td>
<p>Length of the cycle pattern, if present.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>X</code></td>
<td>
<p>Optional t x N data frame (or matrix) of N predictors.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dates</code></td>
<td>
<p>a vector of dates of length t (with elements of class
<code>Date</code>) that correspond to observations in y.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>int.date</code></td>
<td>
<p>Date of the intervention (must be of class <code>Date</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha</code></td>
<td>
<p>Level of credible interval to report for the estimated causal
effect. Default set to 0.05 (i.e., reporting a two-sided 95% credible
interval).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>excl.dates</code></td>
<td>
<p>Optional vector of length t, specifying the dates (if any)
in the post period that should be excluded from the computation of the
causal effect. The elements of the vector must be either 0 (the
corresponding date is retained) or 1 (the corresponding date is excluded).
The first part that corresponds to <code>dates &lt; int.date</code> is ignored.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>horizon</code></td>
<td>
<p>Optional, vector of dates (with elements of class
<code>Date</code>). If provided, a causal effect is computed for the time
horizon(s) between <code>int.date</code> and each specified date. Defaults to the
date of the last observation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>H</code></td>
<td>
<p>P x P variance-covariance matrix of the regression coefficients. Set
by default to H = c(X'X)^(-1) which is akin to the Zellner's g-prior. The
value of the scaling factor is set to <code>c = 1</code>. Alternative priors
could be H = c*diag((X'X)^(-1)) or H = c*I. See also Smith &amp; Kohn, 1995
that suggest setting <code>c</code> in the range [10,1000].</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nu0.r</code></td>
<td>
<p>Degrees of freedom of the Inverse-Wishart prior for each element
of Sigma.r, a vector of errors for state r. Set by default to d + 2 (must
be greater than d - 1).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>s0.r</code></td>
<td>
<p>Scale matrix of the Inverse-Wishart prior for each Sigma.r, a
vector of errors for state r. Must be a (d x d) positive definite. Default
set to the variance-covariance matrix of y multiplied by a scaling factor
of 0.01.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nu0.eps</code></td>
<td>
<p>Degrees of freedom of the Inverse-Wishart prior for Sigma.eps,
a vector of observation errors for each time series. Set by default to d +
2 (must be greater than d - 1).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>s0.eps</code></td>
<td>
<p>Scale matrix of the Inverse-Wishart prior for Sigma.eps, a
vector of observation errors for each time series. Must be a (d x d)
positive definite. Default set to the variance-covariance matrix of y
multiplied by a scaling factor of 0.01.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>niter</code></td>
<td>
<p>Number of MCMC iterations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>burn</code></td>
<td>
<p>Desired burn-in, set by default to 0.1 * <code>niter</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ping</code></td>
<td>
<p>A status message is printed every <code>ping</code> iteration. Default
set to 0.1 * <code>niter</code>. Set to 0 to not track the status.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The assumed model is based on Normally distributed disturbance terms. The argument
<code>components</code> provides flexibility for model formulation, allowing to add
simultaneously up to four components that encapsulate the characteristics of a time series.
</p>
<p>The unknown parameters are the variance-covariance matrices of the error terms and,
if covariates are provided, the matrix of regression coefficients. Because of conjugacy, the
priors placed on the variance-covariance matrices of the error terms are Inverse-Wishart
distributions and the arguments (nu0.eps, s0.eps) and (nu0.r, s0.r) regulate their hyperparameters.
</p>
<p>The regression coefficients are assumed to follow a matrix-Normal prior and, to incorporate
a sparsity assumption, the prior mean is set to zero and a vector selecting the relevant
covariates is introduced with a data augmentation step.
</p>
<p>Sampling from the joint posterior distribution of the states and model parameters is performed
with a Gibbs sampler. The estimated model is then used to perform predictions of the counterfactual
potential outcomes in the period following the intervention date. In a final step, the predictions
are compared to the observed outcomes, thereby defining a causal effect at each time point (pointwise effect).
</p>
<p>The output component <code>general.effect</code> summarizes the estimates of two causal effects: the average
causal effect (temporal average of the pointwise effect) and the cumulative causal effect (cumulative
sum of the pointwise effect).
</p>
<p>Run <code>vignette("CausalMBSTS")</code> for a detailed example.
</p>
<p>For further details see Menchetti &amp; Bojinov (2020).
</p>


<h3>Value</h3>

<p>A list with the following components:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>mcmc</code></td>
<td>
<p>An object of class <code>mbsts</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>predict</code></td>
<td>
<p>A list with the same components as those produced by the function <code>predict.mbsts</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y</code></td>
<td>
<p>Observations in the analysis period (excluding <code>excl.dates</code> if provided).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dates</code></td>
<td>
<p>Dates in the analysis period (excluding <code>excl.dates</code> if provided).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>general</code></td>
<td>
<p>General causal effect for all iterations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>general.effect</code></td>
<td>
<p>Estimated average causal effect, cumulative causal effect and (1-<code>alpha</code>)%
credible intervals. Returns a list if <code>horizon</code> is specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mean.general</code></td>
<td>
<p>Pointwise effect. Returns a list if <code>horizon</code> is specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lower.general</code></td>
<td>
<p>Lower bound of a (1-<code>alpha</code>)% credible interval of the pointwise effect.
Returns a list if <code>horizon</code> is specified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>upper.general</code></td>
<td>
<p>Upper bound of a (1-<code>alpha</code>)% credible interval of the pointwise effect.
Returns a list if <code>horizon</code> is specified.</p>
</td>
</tr>
</table>
<h3>Examples</h3>

<pre><code class="language-R">## Note: The following are toy examples, for a proper analysis we recommend to run
##       at least 1000 iterations and check the convergence of the Markov chain

## Example 1 (daily data, d = 3, local level + seasonal + covariates)
# Generating a panel of observations and a vector of dates
set.seed(1)
y &lt;- cbind(seq(0.5,100,by=0.5)*0.1 + rnorm(200),
           seq(100.25,150,by=0.25)*0.05 + rnorm(200),
           seq(1,200,by=1)*(-0.01) + rnorm(200, 0, 0.5))
dates &lt;- seq.Date(from = as.Date('2019-01-10'),by = "days", length.out = 200)

# Adding a fictional intervention and four covariates (they should be related
# to the outcome but unaffected by the intervention). To illustrate the
# functioning of Bayesian model selection, one covariate is assumed to be
# unrelated to y.
int.date &lt;- as.Date('2019-04-01')
y.new &lt;- y; y.new[dates &gt;= int.date, ] &lt;- y.new[dates &gt;= int.date, ]*1.3
x1 &lt;- y[,1]*0.5 + y[,2]*0.3 + y[,3]*0.1
x2 &lt;- y[,2]*0.1 + rnorm(dim(y)[1],0,0.5)
x3 &lt;- y[,3]*1.2 + rnorm(dim(y)[1],0,0.5)
x4 &lt;- rnorm(dim(y)[1], 5, 10)
X &lt;- cbind(x1, x2, x3, x4)

# Some plots
oldpar &lt;- par(no.readonly = TRUE)
par(mfrow=c(1,3))
for(i in 1:dim(y.new)[2]){
  plot(y.new[,i], x = dates, type='l', col='cadetblue', xlab='', ylab='', main= bquote(Y[.(i)]))
  lines(y[,i], x = dates, col='orange')
  }
par(mfrow=c(1,4))
for(i in 1:dim(X)[2]){
  plot(X[,i], type='l', col = 'darkgreen', x = dates, xlab='', ylab='', main = bquote(x[.(i)]))
  }
par(oldpar)

# Causal effect estimation
causal.1 &lt;- CausalMBSTS(y.new, components = c("trend", "seasonal"), seas.period = 7,
                        X = X, dates = dates, int.date = int.date, s0.r = 0.1*diag(3),
                        s0.eps = 0.1*diag(3),niter = 50, burn = 5,
                        horizon = as.Date(c('2019-04-08','2019-07-28')))
summary(causal.1)

## Example 2 (weekly data, local level + cycle, d = 2)
set.seed(1)
t &lt;- seq(from = 0,to = 4*pi, length.out=300)
y &lt;- cbind(3*sin(2*t)+rnorm(300), 2*cos(2*t) + rnorm(300))
dates &lt;- seq.Date(from = as.Date("2015-01-01"), by = "week", length.out=300)
int.date &lt;- as.Date("2020-02-27")
y[dates &gt;= int.date,] &lt;- y[dates &gt;= int.date,]+2

# Some plots
plot(y = y[,1], x=dates, type="l", col="cadetblue")
lines(y = y[,2], x = dates, col = "orange")
abline(v=int.date, col="red")

# Causal effect estimation
causal.2 &lt;- CausalMBSTS(y, components = c("trend", "cycle"), cycle.period = 75,
                        dates = dates, int.date = int.date, s0.r = 0.01*diag(2),
                        s0.eps = 0.1*diag(2), niter = 100, burn = 10)
summary(causal.2)
</code></pre>


</div>