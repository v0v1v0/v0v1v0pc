<div class="container">

<table style="width: 100%;"><tr>
<td>batch</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Interface to CycleStreets Batch Routing API</h2>

<h3>Description</h3>

<p>Note: set <code>CYCLESTREETS_BATCH</code>, <code>CYCLESTREETS_PW</code> and <code>CYCLESTREETS_PW</code>
environment variables, e.g. with <code>usethis::edit_r_environ()</code>
before trying this.
</p>


<h3>Usage</h3>

<pre><code class="language-R">batch(
  desire_lines = NULL,
  id = NULL,
  directory = tempdir(),
  wait = FALSE,
  wait_time = NULL,
  name = "Batch job",
  serverId = 21,
  strategies = "quietest",
  bothDirections = 0,
  minDistance = 50,
  maxDistance = 5000,
  filename = "test",
  includeJsonOutput = 1,
  emailOnCompletion = "you@example.com",
  username = Sys.getenv("CYCLESTREETS_UN"),
  password = Sys.getenv("CYCLESTREETS_PW"),
  base_url = "https://api.cyclestreets.net/v2/batchroutes.createjob",
  pat = Sys.getenv("CYCLESTREETS_BATCH"),
  silent = TRUE,
  delete_job = TRUE,
  cols_to_keep = c("id", "name", "provisionName", "distances", "time", "quietness",
    "gradient_smooth"),
  segments = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>desire_lines</code></td>
<td>
<p>Geographic desire lines representing origin-destination data</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>id</code></td>
<td>
<p>int
Batch job ID, as returned from batchroutes.createjob.
action string (start|pause|continue|terminate)
Action to take. Available actions are:
start: Start (open) job
pause: Pause job
continue: Continue (re-open) job
terminate: Terminate job and delete data</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>directory</code></td>
<td>
<p>Where to save the data? <code>tempdir()</code> by default</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wait</code></td>
<td>
<p>Should the process block your R session but return a route?
FALSE by default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wait_time</code></td>
<td>
<p>How long to wait before getting the data in seconds?
NULL by default, meaning it will be calculated by the private function
<code>wait_s()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>name</code></td>
<td>
<p>The name of the batch routing job for CycleStreets</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>serverId</code></td>
<td>
<p>The server ID to use (21 by default)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>strategies</code></td>
<td>
<p>Route plan types, e.g. <code>"fastest"</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bothDirections</code></td>
<td>
<p>int (1|0)
Whether to plan in both directions, i.e. A-B as well as B-A.
0, meaning only one way routes, is the default in the R default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>minDistance</code></td>
<td>
<p>Min Euclidean distance of routes to be calculated</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>maxDistance</code></td>
<td>
<p>Maximum Euclidean distance of routes to be calculated</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>filename</code></td>
<td>
<p>Character string</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>includeJsonOutput</code></td>
<td>
<p>int (1|0)
Whether to include a column in the resulting CSV data giving the full JSON output from the API, rather than just summary
information like distance and time.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>emailOnCompletion</code></td>
<td>
<p>Email on completion?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>username</code></td>
<td>
<p>string
Your CycleStreets account username. In due course this will be replaced with an OAuth token.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>password</code></td>
<td>
<p>string
Your CycleStreets account password. You can set it with
Sys.setenv(CYCLESTREETS_PW="xxxxxx")</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>base_url</code></td>
<td>
<p>The base url from which to construct API requests
(with default set to main server)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pat</code></td>
<td>
<p>The API key used. By default this uses <code>Sys.getenv("CYCLESTREETS")</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>silent</code></td>
<td>
<p>Logical (default is FALSE). TRUE hides request sent.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>delete_job</code></td>
<td>
<p>Delete the job? TRUE by default to avoid clogged servers</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cols_to_keep</code></td>
<td>
<p>Columns to return in output sf object</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>segments</code></td>
<td>
<p>logical, return segments TRUE/FALSE/"both"</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>See https://www.cyclestreets.net/journey/batch/ for web UI.
</p>
<p>Recommneded max batch size: 300k routes
</p>


<h3>Examples</h3>

<pre><code class="language-R">if(FALSE) {
library(sf)
desire_lines = od::od_to_sf(od::od_data_df, od::od_data_zones)[4:5, 1:3]
u = paste0("https://github.com/cyclestreets/cyclestreets-r/",
  "releases/download/v0.5.3/od-longford-10-test.Rds")
desire_lines = readRDS(url(u))
routes_id = batch(desire_lines, username = "robinlovelace", wait = FALSE)
# Wait for some time, around a minute or 2
routes_wait = batch(id = routes_id, username = "robinlovelace", wait = TRUE, delete_job = FALSE)
names(routes_wait)
plot(routes_wait)
plot(desire_lines$geometry[4])
plot(routes_wait$geometry[routes_wait$route_number == "4"], add = TRUE)
head(routes_wait$route_number)
unique(routes_wait$route_number)
# Job is deleted after this command:
routes_attrib = batch(desire_lines, id = routes_id, username = "robinlovelace", wait = TRUE)
names(routes_attrib)
unique(routes_attrib$route_number)
desire_lines_huge = desire_lines[sample(nrow(desire_lines), 250000, replace = TRUE), ]
routes_id = batch(desire_lines_huge, username = "robinlovelace", wait = FALSE)
names(routes)
plot(routes$geometry)
plot(desire_lines$geometry, add = TRUE, col = "red")
routes = batch(desire_lines, username = "robinlovelace", wait_time = 5)
# profvis::profvis(batch_read("test-data.csv.gz"))
}
</code></pre>


</div>