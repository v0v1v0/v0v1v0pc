<div class="container">

<table style="width: 100%;"><tr>
<td>handle_gsod</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>List, download or convert to chillR format data from the Global Summary of
the Day database</h2>

<h3>Description</h3>

<p>This function can do four things related to the Global Summary of the Day
("GSOD") database from the National Climatic Data Centre (NCDC) of the
National Oceanic and Atmospheric Administration (NOAA): </p>

<ul>
<li>
<p>1. It can list stations that are close to a specified position (geographic coordinates).
</p>
</li>
<li>
<p>2. It can retrieve weather data for a named weather station (or a vector of multiple stations).
For the name, the chillRcode from the list returned by the <code>list_stations</code> operation
should be used.
</p>
</li>
<li>
<p>3. It can 'clean' downloaded data (for one or multiple stations), so that they can easily be used in chillR
</p>
</li>
<li>
<p>4. It can delete the downloaded intermediate weather files from the machine
</p>
<p>Which of these functions is carried out depends on the <code>action</code> argument.
</p>
</li>
</ul>
<p>This function can run independently, but it is also called by the
<code>get_weather</code> and <code>weather2chillR</code> functions, which some users might find a bit
easier to handle.
</p>


<h3>Usage</h3>

<pre><code class="language-R">handle_gsod(
  action,
  location = NULL,
  time_interval = c(1950, 2020),
  stations_to_choose_from = 25,
  end_at_present = FALSE,
  add.DATE = FALSE,
  update_station_list = FALSE,
  path = "climate_data",
  update_all = FALSE,
  clean_up = NULL,
  override_confirm_delete = FALSE,
  max_distance = 150,
  min_overlap = 0,
  verbose = "normal"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>action</code></td>
<td>
<p>accepts 4 types of inputs to decide on the mode of action for the function.</p>

<ul>
<li>
<p>if this is the character string <code>"list_stations"</code>, the function
will return a list of the weather stations from the database that are
closest to the geographic coordinates specified by location.
</p>
</li>
<li>
<p>if this is the character string <code>"download_weather"</code>, the function will attempt to download
weather data from the database for the station named by the location
argument, which should then be a character string corresponding to the
<code>chillRcode</code> of the station (which you can get by running this function in
<code>'list_stations'</code> mode).
</p>
</li>
<li>
<p>if this is the character string <code>"delete"</code>, the function will attempt to remove
the intermediate downloaded weather data, which was saved in the folder specified by <code>"path"</code> argument.
</p>
</li>
<li>
<p>if this is a collection of outputs obtained by
running this function in the <code>'download weather'</code> mode), the function cleans the
weather files and make them ready for use in <code>chillR</code>. If the input is just a dataframe
(not a list, as produced with this function), you have to specify the
database name with the database argument.</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>location</code></td>
<td>
<p>either a vector of geographic coordinates (for the
<code>'list_stations'</code> mode), or the 'chillRcode' of a weather station in the
specified database (for the <code>'download_weather'</code> mode). When running this
function for data cleaning only, this is not needed. For the
<code>'download_weather'</code> mode, this can also be a vector of 'chillRcodes',
in which case records for all stations will be downloaded. The data cleaning
mode can also handle a list of downloaded weather datasets.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>time_interval</code></td>
<td>
<p>numeric vector with two elements, specifying the start
and end date of the period of interest. Only required when running in
<code>'list_stations'</code> or <code>'download_weather'</code> mode. The default is c(1950,2020).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>stations_to_choose_from</code></td>
<td>
<p>if the location is specified by geographic
coordinates, this argument determines the number of nearby stations in the
list that is returned.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>end_at_present</code></td>
<td>
<p>boolean variable indicating whether the interval of
interest should end on the present day, rather than extending until the end
of the year specified under <code>time_interval[2]</code> (if <code>time_interval[2]</code> is the
current year).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>add.DATE</code></td>
<td>
<p>is a boolean parameter to be passed to <code>make_all_day_table</code> if <code>action</code> is 
a collection of outputs (in the form of list) from the function in the downloading format.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>update_station_list</code></td>
<td>
<p>boolean, by default set FALSE. Decides if the weather station list is read from the disk (if present) or if it is newly downloaded in case of action = list_stations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>path</code></td>
<td>
<p>character, by default "climate_data". Specifies the folder, relative to the working directory where the weather data is downloaded to.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>update_all</code></td>
<td>
<p>boolean, by default set to FALSE. If set TRUE, it will download every stations data, even if previously downloaded and 
still present in the temporary folder, specifief by the function argument <code>path</code>. If set FALSE, already downloaded years of a station will be skipped
when download action is carried out again.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>clean_up</code></td>
<td>
<p>character, by default set to NULL. In combination with 'action = delete', this can be set to 'all' to delete all weather data, or 'station' if only data from specific stations ('location') should be deleted</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>override_confirm_delete</code></td>
<td>
<p>Boolean, request whether the delete function needs user confirmation to run. Defaults to <code>FALSE</code>, and
Should be set to <code>TRUE</code> if the function needs to be run without user intervention.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>max_distance</code></td>
<td>
<p>numeric, by default 150. Expresses the distance in kilometers how far away
weather stations can be located from the original location, when searching for weather stations</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>min_overlap</code></td>
<td>
<p>numeric, by default set to 0. Expresses in percent how much of the specified period needs to be covered by weather station to be 
included in the list, when searching for stations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>is a character, deciding how much information is returned while downloading
the weather data. By default set to "normal". If set to "detailed" the function
will say how many years of data have been successfully downloaded for each station. If set "quiet" no
information is printed during download.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The GSOD database is described here:
<a href="https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00516">https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00516</a>
</p>
<p>under the <code>'list_stations'</code> mode, several formats are possible for specifying
the location vector, which can consist of either two or three coordinates
(it can include elevation). Possible formats include <code>c(1, 2, 3)</code>, <code>c(1, 2)</code>,
<code>c(x = 1, y = 2, z = 3)</code>, <code>c(lat = 2, long = 1, elev = 3)</code>. If elements of the vector are not
names, they are interpreted as c(Longitude, Latitude, Elevation).
</p>
<p>The 'chillRCode' is generated by this function, when it is run with
geographic coordinates as location inputs. In the list of nearby stations
that is returned then, the chillRCode is provided and can then be used as
input for running the function in 'downloading' mode. For downloading the
data, use the same call as before but replace the location argument with the
chillRCode.
</p>


<h3>Value</h3>

<p>The output depends on the action argument. If it is <code>'list_stations'</code>,
the function returns a list of <code>station_to_choose_from</code> weather stations that
are close to the specified location. This list also contains information
about how far away these stations are (in km), how much the elevation
difference is (if elevation is specified; in m) and how much overlap there
is between the data contained in the database and the time period specified
by <code>time_interval</code>. If action is <code>'download_weather'</code> the output is a list of
the downloaded weather record, extended
to the full duration of the specified time interval. If the <code>location</code> input
was a vector of stations, the output will be a list of such objects.
If action is a weather <code>data.frame</code> or a weather record downloaded with
this function (in <code>'download_weather'</code> mode), the data structure remains
in the same, but the data are processed for easy use with <code>chillR</code>.
If drop_most was set to <code>TRUE</code>, most columns are dropped. If the
<code>location</code> input was a list of weather datasets, all elements of the
list will be processed.
**IMPORTANT NOTE:** as of <code>chillR</code> version 0.73, the output format no
longer contains a list element that specifies the database name, because this
has been considered confusing (and annoying) by various users. This means,
however, that some earlier calls to results from the <code>handle_gsod</code> function
may produce errors now. 
Also note that a few parameters, <code>station_list</code>, <code>drop_most</code>,
<code>quiet</code>, <code>add_station_name</code> are no longer needed due to some
reworking of the function's mechanisms. After careful consideration, we
decided to drop these parameters entirely, which may lead to some downward
compatibility problems.
Apologies for any inconvenience caused by this transition. If you want to
keep using the previous function (which is much slower), feel free to adopt
the deprecated <code>handle_gsod_old</code> function - but note that this will no
longer be updated and may disappear eventually.
</p>


<h3>Note</h3>

<p>Many databases have data quality flags, which may sometimes indicate
that data aren't reliable. These are not considered by this function!
</p>
<p>For many places, the GSOD database is quite patchy, and the length of the
record indicated in the summary file isn't always very useful (e.g. there
could only be two records for the first and last date). Files are downloaded
by year, so if we specify a long interval, this may take a bit of time.
</p>


<h3>Author(s)</h3>

<p>Adrian Fülle, Lars Caspersen, Eike Luedeling
</p>


<h3>References</h3>

<p>The chillR package:
</p>
<p>Luedeling E, Kunz A and Blanke M, 2013. Identification of chilling and heat
requirements of cherry trees - a statistical approach. International Journal
of Biometeorology 57,679-689.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
#coordinates of Bonn
long &lt;- 7.0871843
lat &lt;- 50.7341602

#get a list of close-by weather stations
# stationlist &lt;-
#   handle_gsod(action = "list_stations",
#               time_interval = c(1995,2000),
#               location = c(long,lat))

#download data
# test_data &lt;-
#   handle_gsod(action = "download_weather",
#               time_interval = c(1995,2000),
#               location = stationlist$chillR_code[c(1,2)])
# 
# format downloaded data
# test_data_clean &lt;- handle_gsod(action = test_data)

## data deletion on disk for clean_up

# functions will ask for confirmation in the console - 'y' for yes to
# confirm deletion, anything else cancels the deletion

# handle_gsod(action = "delete",
#             clean_up = "all",
#             override_confirm_delete = TRUE)

</code></pre>


</div>