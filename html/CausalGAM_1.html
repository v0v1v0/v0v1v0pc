<div class="container">

<table style="width: 100%;"><tr>
<td>balance.IPW</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>
Check Post-Weighting Balance for (A)IPW Estimators Using Generalized Additive Models</h2>

<h3>Description</h3>

<p>This function calculates weighted means of covariates where weights in inverse propensity weights and then examines the differences in the weighted means across treated and control units as a diagnostic for covariate balance.  
</p>


<h3>Usage</h3>

<pre><code class="language-R">balance.IPW(pscore.formula, pscore.family,
             treatment.var, outcome.var, data = NULL, 
             divby0.action = c("fail", "truncate", "discard"), 
             divby0.tol = 1e-08, nboot = 501, 
             suppress.warnings = TRUE, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>pscore.formula</code></td>
<td>

<p>A formula expression for the propensity score model. See the documentation of <code>gam</code> for details. 
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pscore.family</code></td>
<td>

<p>A description of the error distribution and link function to be used for the propensity score model. See the documentation of <code>gam</code> for details.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>treatment.var</code></td>
<td>

<p>A character variable giving the name of the binary treatment variable in <code>data</code>. If <code>treatment.var</code> is a numeric variable, it is assumed that <em>control</em> corresponds to <code>sort(unique(treatment.values))[1]</code> and <em>treatment</em> corresponds to <code>sort(unique(treatment.values))[2]</code>. If <code>treatment.var</code> is a factor, it is assumed that <em>control</em> corresponds to <code>levels(treatment.values)[1]</code> and <em>treatment</em> corresponds to <code>levels(treatment.values)[2]</code>.
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>outcome.var</code></td>
<td>
<p>A character variable giving the name of the outcome variable in <code>data</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>

<p>A <em>non-optional</em> data frame containing the variables in the propensity score model along with all covariates that one wishes to assess balance for. <strong><code>data</code> cannot contain any missing values.</strong>   
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>divby0.action</code></td>
<td>

<p>A character variable describing what action to take when some estimated propensity scores are less than <code>divby0.tol</code> or greater than <code class="reqn">1 - \code{divby0.tol}</code>. Options include: ‘<span class="samp">⁠fail⁠</span>’ (abort the call to <code>estimate.ATE</code>), ‘<span class="samp">⁠truncate⁠</span>’ (set all estimated propensity scores less than <code>divby0.tol</code> equal to <code>divby0.tol</code> and all estimated propensity scores greater than <code class="reqn">1 - \code{divby0.tol}</code> equal to <code class="reqn">1 - \code{divby0.tol}</code>), and ‘<span class="samp">⁠discard⁠</span>’ (discard units that have estimate propensity scores less than <code>divby0.tol</code> or greater than <code class="reqn">1 - \code{divby0.tol}</code>). Note that discarding units will change the estimand.   
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>divby0.tol</code></td>
<td>

<p>A scalar in <code class="reqn">[0,0.5)</code> giving the tolerance level for extreme propensity scores. Defaults to <code class="reqn">1e-8</code>. See <code>divby0.action</code> for details. 
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nboot</code></td>
<td>

<p>Number of bootrap replications used for calculating bootstrap standard errors. If <code>nboot</code> is less than or equal to 0 then bootstrap standard errors are not calculated. Defaults to 501. 	
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>suppress.warnings</code></td>
<td>

<p>Logical value indicating whether warnings from the <code>gam</code> fitting procedures should be suppressed from printing to the screen. Defaults to <code>TRUE</code>. 
</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>

<p>Further arguments to be passed.
</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>This function provides diagnostic information that allows a
user to judge whether the inverse propensity weights generated from a
particular generalized additive model specification result in
covariate balance across treated and control groups. The function is
intended to be used before the <code>estimate.ATE</code> function in order
to find a specification for the propensity score model that results in
sufficient covariate balance. 
</p>
<p>The weighted mean differences between all variables in the dataset
passed to <code>balance.IPW</code> are reported along with a z-statistics
for these weighted differences. Univariate mean covariate balance is
decreasing in the absolute value of the z-statistics (z-statistics
closer to 0 imply better univariate mean balance).
</p>
<p>Printing the output from <code>balance.IPW</code> will result in a table
with <code class="reqn">k-2</code> rows (one for each variable other than the treatment
and outcome variables) and <code class="reqn">6</code> columns. The columns are (from left
to right) the observed mean of the covariate among the treated units,
the observed mean of the covariate among the control units, the
weighted mean of the covariate among the treated units, the weighted
mean of the covariate among the control units, the weighted mean
difference, and the z-statistic for the difference.
</p>
<p>It is often useful to include interactions and powers of the
covariates in the dataset so that balance can be checked for these
quantities as well.
</p>
<p>Means, mean differences, and z-statistics are only reported for numeric covariates. 
</p>


<h3>Value</h3>

<p>An object of class <code>balance</code> with the following attributes: 
</p>
<table>
<tr style="vertical-align: top;">
<td><code>obs.mean.control</code></td>
<td>
<p>The observed mean of each of the covariates within the control units.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>obs.mean.treated</code></td>
<td>
<p>The observed mean of each of the covariates within the treated units.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weighted.mean.control</code></td>
<td>
<p>The weighted mean of each of the covariates within the control units.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weighted.mean.treated</code></td>
<td>
<p>The weighted mean of each of the covariates within the treated units.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weighted.diff.SE</code></td>
<td>
<p>The bootstrap standard errors for the differences betwen <code>weighted.mean.treated</code> and <code>weighted.mean.control</code>.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Adam Glynn, Emory University
</p>
<p>Kevin Quinn, University of Michigan
</p>


<h3>References</h3>

<p>Adam N. Glynn and Kevin M. Quinn. 2010. "An Introduction to the Augmented Inverse Propensity Weighted Estimator." <em>Political Analysis</em>. 
</p>


<h3>See Also</h3>

<p><code>gam</code>, <code>estimate.ATE</code></p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
set.seed(1234)
## number of units in sample
n &lt;- 2000


## measured potential confounders
z1 &lt;- rnorm(n)
z2 &lt;- rnorm(n)
z3 &lt;- rnorm(n)
z4 &lt;- rnorm(n)

## treatment assignment
prob.treated &lt;-	pnorm(-0.5 + 0.75*z2)
x &lt;- rbinom(n, 1, prob.treated)

## potential outcomes
y0 &lt;- z4 + rnorm(n)
y1 &lt;- z1 + z2 + z3 + cos(z3*2) + rnorm(n)

## observed outcomes
y &lt;- y0
y[x==1] &lt;- y1[x==1] 	     	


## put everything in a data frame
examp.data &lt;- data.frame(z1, z2, z3, z4, x, y)

## augment data with interactions and powers of covariates
examp.data$z1z1 &lt;- examp.data$z1^2
examp.data$z2z2 &lt;- examp.data$z2^2
examp.data$z3z3 &lt;- examp.data$z3^2
examp.data$z4z4 &lt;- examp.data$z4^2

examp.data$z1z2 &lt;- examp.data$z1 * examp.data$z2
examp.data$z1z3 &lt;- examp.data$z1 * examp.data$z3
examp.data$z1z4 &lt;- examp.data$z1 * examp.data$z4

examp.data$z2z3 &lt;- examp.data$z2 * examp.data$z3
examp.data$z2z4 &lt;- examp.data$z2 * examp.data$z4

examp.data$z3z4 &lt;- examp.data$z3 * examp.data$z4



## check balance of a propensity score model that is not sufficient to
## control confounding bias

bal.1 &lt;- balance.IPW(pscore.formula=x~s(z3)+s(z4),
                     pscore.family=binomial(probit),
                     treatment.var="x",
                     outcome.var="y",
                     data=examp.data,
                     nboot=250)

print(bal.1) ## some big z-statistics here indicating balance not so great


## try again
bal.2 &lt;- balance.IPW(pscore.formula=x~z1+z2+z3+z4,
                     pscore.family=binomial(probit),
                     treatment.var="x",
                     outcome.var="y",
                     data=examp.data,
                     nboot=250)

print(bal.2) ## balance looks much better-- 
             ##    only 1 out of 14 zs &gt; 2.0 in absval


## End(Not run)
</code></pre>


</div>