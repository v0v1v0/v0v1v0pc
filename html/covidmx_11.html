<div class="container">

<table style="width: 100%;"><tr>
<td>descarga_db</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Auxiliares para la descarga de datos abiertos</h2>

<h3>Description</h3>

<p>Conjunto de funciones para apoyar la descarga de datos abiertos de
la Direccion General de Epidemiologia (DGE)
</p>
<p>La funcion de descarga principal es <code>descarga_datos_abiertos()</code> llama las siguientes funciones
en orden:
</p>

<ul>
<li> <p><code>descarga_diccionario()</code> Se encarga de descargar y formatear el diccionario de datos
</p>
</li>
<li> <p><code>descarga_db()</code> Se encarga de descargar y formatear la base de datos
</p>
</li>
<li> <p><code>pega_db_datos_abiertos_tbl_y_diccionario()</code> Pega ambos en el formato lista de <code>covidmx</code>
</p>
</li>
</ul>
<p>A su vez <code>descarga_diccionario()</code> ejecuta las siguientes para obtener el diccionario de datos:
</p>

<ul>
<li> <p><code>descarga_db_diccionario_ssa()</code> Descarga el diccionario de la DGE
</p>
</li>
<li> <p><code>unzip_db_diccionario_ssa()</code> Libera el archivo <code>zip</code> descargado
</p>
</li>
<li> <p><code>parse_db_diccionario_ssa()</code> Genera una lista de tiblles con el diccionario por variable
</p>
</li>
</ul>
<p>Por otro lado,<code>descarga_db()</code> ejecuta las siguientes para obtener los datos abiertos:
</p>

<ul>
<li> <p><code>descarga_db_datos_abiertos_tbl()</code> Descarga las bases de datos de covid de la DGE
</p>
</li>
<li> <p><code>unzip_db_datos_abiertos_tbl()</code> Libera el archivo <code>zip</code> descargado
</p>
</li>
<li> <p><code>parse_db_datos_abiertos_tbl()</code> Genera una base de datos en <code>duckdb</code> (o <code>tibble</code>) con la informacion
</p>
</li>
</ul>
<p>Si en algun momento se interrumpio la descarga o hubo problemas de conexion o detuviste
el proceso de generacion de la base de datos abiertos puedes llamar a las funciones
de <code>read_datos_abiertos()</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">descarga_db(
  read_format = c("duckdb", "tibble"),
  tblname = "covidmx",
  pragma_memory_limit = Sys.getenv("pragma_memory_limit"),
  drv = duckdb::duckdb(),
  dbdir = tempfile(fileext = ".duckdb"),
  colClasses = get_col_class(),
  sites.covid = get_sites_covid(),
  download_process = c("pins", "download.file"),
  unzip_command = Sys.getenv("unzip_command"),
  unzip_args = Sys.getenv("unzip_args"),
  check_unzip_install = TRUE,
  clear_zip = (download_process[1] != "pins"),
  clear_csv = TRUE,
  force_download = FALSE,
  show_warnings = TRUE,
  datos_abiertos_zip_paths = NULL,
  datos_abiertos_unzipped_path = NULL,
  datos_abiertos_tbl = NULL,
  quiet = FALSE,
  board_url_name = "datos_abiertos",
  cache = NULL,
  use_cache_on_failure = TRUE,
  download_file_args = list(method = "curl", destfile = tempfile(), quiet = quiet),
  descarga_db_datos_abiertos_tbl_args = list(),
  ...
)

descarga_diccionario(
  download_process = c("pins", "download.file"),
  site.covid.dic = get_site_dic(),
  quiet = FALSE,
  clear_zip = download_process[1] != "pins",
  clear_csv = TRUE,
  diccionario_zip_path = NULL,
  diccionario_unzipped_path = NULL,
  diccionario = NULL,
  board_url_name_dict = "diccionario_covid",
  cache_diccionario = NULL,
  use_cache_on_failure = TRUE,
  force_download = FALSE,
  show_warnings = TRUE,
  download_file_args_dict = list(method = "curl", destfile = tempfile(), quiet = quiet),
  unzip_args_dict = list(exdir = ".", overwrite = TRUE),
  descarga_db_diccionario_ssa_args = list()
)

descarga_db_datos_abiertos_tbl(
  download_process = c("pins", "download.file"),
  sites.covid = get_sites_covid(),
  quiet = FALSE,
  board_url_name = "datos_abiertos",
  cache = NULL,
  use_cache_on_failure = TRUE,
  force_download = FALSE,
  show_warnings = TRUE,
  download_file_args = list(method = "curl", destfile = tempfile(), quiet = quiet),
  ...
)

descarga_db_diccionario_ssa(
  download_process = c("pins", "download.file"),
  site.covid.dic = get_site_dic(),
  quiet = FALSE,
  board_url_name_dict = "diccionario_covid",
  cache_diccionario = NULL,
  use_cache_on_failure = TRUE,
  force_download = FALSE,
  show_warnings = TRUE,
  download_file_args_dict = list(method = "curl", destfile = tempfile(), quiet = quiet),
  ...
)

unzip_db_datos_abiertos_tbl(
  datos_abiertos_zip_paths,
  unzip_command = Sys.getenv("unzip_command"),
  unzip_args = Sys.getenv("unzip_args"),
  check_unzip_install = TRUE,
  quiet = FALSE,
  clear_zip = FALSE
)

unzip_db_diccionario_ssa(
  diccionario_zip_path,
  unzip_args_dict = list(exdir = ".", overwrite = TRUE),
  clear_zip = FALSE
)

parse_db_diccionario_ssa(diccionario_unzipped_path, clear_csv = FALSE)

parse_db_datos_abiertos_tbl(
  datos_abiertos_unzipped_path,
  read_format = c("duckdb", "tibble"),
  pragma_memory_limit = Sys.getenv("pragma_memory_limit"),
  dbdir = tempfile(fileext = ".duckdb"),
  drv = duckdb::duckdb(),
  colClasses = get_col_class(),
  tblname = "covidmx",
  quiet = TRUE,
  clear_csv = FALSE,
  ...
)

pega_db_datos_abiertos_tbl_y_diccionario(datos_abiertos_tbl, diccionario)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>read_format</code></td>
<td>
<p>(<strong>opcional</strong>) <code>"duckdb"</code> o <code>"tibble"</code> establece el formato
de lectura de la base de datos. En la mayoria de los casos <code>"tibble"</code> va a
resultar en un error de memoria. La opcion de <code>"duckdb"</code> siempre es mas rapida por lo cual
es el default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tblname</code></td>
<td>
<p>(<strong>opcional</strong>)  Nombre de la tabla de <code>duckdb</code> donde guardar los datos por
default se llama <code>covidmx</code>. Solo es relevante si estas usando el mismo <code>dbdir</code> para otro
proyecto distinto.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pragma_memory_limit</code></td>
<td>
<p>(<strong>opcional</strong>) Limite de memoria para el programa
(ver <a href="https://duckdb.org/docs/sql/pragmas">PRAGMAS</a>). Cambialo a que sea mas o menos la mitad
de tu RAM. La forma mas sencilla es como una variable ambiental con
<code>Sys.setenv('pragma_memory_limit' = '1GB')</code> por ejemplo para un limite de 1 gigabyte.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>drv</code></td>
<td>
<p>(<strong>opcional</strong>) Un  driver para <code>dbConnect</code> (default <code>duckdb::duckdb()</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dbdir</code></td>
<td>
<p>(<strong>opcional</strong>) Direccion donde guardar la base de datos con terminacion <code>.duckdb</code>.
Corresponde al argumento de <code>duckdb::dbConnect__duckdb_driver()</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colClasses</code></td>
<td>
<p>(<strong>opcional</strong>) Clases de la columna para leer en <code>duckdb::read_csv_duckdb()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sites.covid</code></td>
<td>
<p>(<strong>opcional</strong>)  Sitios web con el vinculo a los archivos <code>.zip</code> de l
os datos abiertos. Puedes cambiarlo por uno de los historicos, por ejemplo. La estructura es
<code>c("nombre" = "url", "nombre2" = "url2")</code>. La ultima verificacion del sitio web default fue
el 6 de septiembre del 2022.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>download_process</code></td>
<td>
<p>(<strong>opcional</strong>)  Metodo para descargar ya sea <code>pins</code> o <code>download.file</code>.
Se recomienda <code>pins</code> pues guarda en memoria la fecha de la ultima descarga y analiza
si ha pasado mas de un dia desde la descarga. En caso afirmativo verifica si el
archivo ha cambiado y si hubo cambios entonces lo descarga.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>unzip_command</code></td>
<td>
<p>(<strong>opcional</strong>) Forma de extraer la base de datos de datos abiertos
si <code>unzip</code> falla.
La forma de llamarla es con <code>system2(unzip_command, args = c(unzip_args, file_download_data))</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>unzip_args</code></td>
<td>
<p>(<strong>opcional</strong>) Argumentos de extraccion de la base de datos de datos abiertos
si <code>unzip</code> falla.
La forma de llamarla es con <code>system2(unzip_command, args = c(unzip_args, file_download_data))</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>check_unzip_install</code></td>
<td>
<p>(<strong>opcional</strong>) Bandera de verificacion para checar si tienes
lo necesario para unzippear los datos en el caso de que <code>unzip</code> no sirva.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>clear_zip</code></td>
<td>
<p>(<strong>opcional</strong>) Si borrar los archivos <code>.zip</code> descargados para el diccionario
y los datos abiertos. No se recomienda si estas usando <code>pins</code>. Ve la nota para mas informacion.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>clear_csv</code></td>
<td>
<p>(<strong>opcional</strong>) Si borrar los archivos <code>.csv</code> que se generan despues de abrir
el zip. El default es que si pues en general solo requieres el <code>duckdb</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>force_download</code></td>
<td>
<p>(<strong>opcional</strong>) Analiza si cambio el pin y descarga datos nuevos en caso
afirmativo aunque haya pasado menos de un dia.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>show_warnings</code></td>
<td>
<p>(<strong>opcional</strong>) si arrojar <code>warnings</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>datos_abiertos_zip_paths</code></td>
<td>
<p>(<strong>opcional</strong>)  Camino a los datos abiertos si ya los
descargaste en <code>zip</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>datos_abiertos_unzipped_path</code></td>
<td>
<p>(<strong>opcional</strong>)  Camino a los datos abiertos <code>csv</code> si ya
los descargaste y descomprimiste el archivo <code>zip</code> en un <code>csv</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>datos_abiertos_tbl</code></td>
<td>
<p>(<strong>opcional</strong>) Camino a un archivo <code>.duckdb</code> con los datos formateados</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quiet</code></td>
<td>
<p>(<strong>opcional</strong>) Variable para no mostrar mensajes</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>board_url_name</code></td>
<td>
<p>(<strong>opcional</strong>) Establece el nombre del <code>pins::board_url</code> para
los datos abiertos (si ya usas pins para que no se empalme).
Por default se llama <code>datos_abiertos</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cache</code></td>
<td>
<p>parametro para el cache de <code>pins::board_url</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use_cache_on_failure</code></td>
<td>
<p>(<strong>opcional</strong>) Booleana. Establece que si no se pueden descargar
datos nuevos utilice los que tenga en memoria. Por default es <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>download_file_args</code></td>
<td>
<p>(<strong>opcional</strong>) Lista de argumentos adicionales para <code>download.file</code>
de los datos si se elige este metodo para descargar.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>descarga_db_datos_abiertos_tbl_args</code></td>
<td>
<p>(<strong>opcional</strong>) Lista con argumentos adicionales
para el <code>pins::pin_download</code> de datos abiertos</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Parametros adicionales para <code>pins::pin_download</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>site.covid.dic</code></td>
<td>
<p>(<strong>opcional</strong>)  Sitio desde el cual descarga del diccionario de datos.
La ultima verificacion del sitio fue el 6 de septiembre 2022.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>diccionario_zip_path</code></td>
<td>
<p>(<strong>opcional</strong>)  Camino al diccionario si ya losdescargaste en <code>zip</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>diccionario_unzipped_path</code></td>
<td>
<p>(<strong>opcional</strong>)  Camino al diccionario <code>csv</code> si ya
lo descargaste y descomprimiste el archivo <code>zip</code> en un <code>csv</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>diccionario</code></td>
<td>
<p>(<strong>opcional</strong>)  Lo que resulta de realizar una descarga del diccionario
usando <code>descarga_diccionario</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>board_url_name_dict</code></td>
<td>
<p>(<strong>opcional</strong>) Establece el nombre del <code>pins::board_url</code> para los
datos abiertos. Por default se llama <code>diccionario_covid</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cache_diccionario</code></td>
<td>
<p>(<strong>opcional</strong>) Direccion donde guardar el diccionario en memoria
usando <code>pins</code> para no tener que volver a descargarlo si nada ha cambiado</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>download_file_args_dict</code></td>
<td>
<p>(<strong>opcional</strong>) Lista de argumentos adicionales
para <code>download.file</code> del diccionario si se elige este metodo de descarga.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>unzip_args_dict</code></td>
<td>
<p>(<strong>opcional</strong>) Lista de argumentos para usar <code>utils::unzip</code> en el
diccionario de datos.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>descarga_db_diccionario_ssa_args</code></td>
<td>
<p>(<strong>opcional</strong>) Lista con argumentos adicionales para el
<code>pins::pin_download</code> de datos abiertos</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>Lista de valores:
</p>

<ul>
<li>
<p> dats        - Tabla conectada mediante <code>duckdb::dbConnect__duckdb_driver()</code> (si <code>duckdb</code>) o
tibble (si <code>tibble</code>)
</p>
</li>
<li>
<p> disconnect  - Funcion para cerrar la conexion a la base de datos.
</p>
</li>
<li>
<p> dict        - Lista de <code>tibble</code>s con el diccionario de datos para cada variable
</p>
</li>
</ul>
<h3>See Also</h3>

<p><code>descarga_datos_abiertos()</code> <code>read_datos_abiertos()</code>  <code>descarga_datos_red_irag()</code>
<code>descarga_datos_variantes_GISAID()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
#Estos links deben omitirse en una corrida normal. Se incluyen por ahora como ejemplo
#pero las opciones site.covid.dic y sites.covid deben eliminarse de abajo.
diclink   &lt;- "https://github.com/RodrigoZepeda/covidmx/raw/main/diccionario_datos_covid19.zip"
dlink     &lt;- "https://github.com/RodrigoZepeda/covidmx/raw/main/datos_abiertos_covid19.zip"

#' #En el ejemplo de R por normas de CRAN tenemos que hacerlo así pero en tu
#computadora puedes solo usar descargar datos sin el if else
if (RCurl::url.exists(dlink) &amp; RCurl::url.exists(diclink)){
  
  # Descarga solo el diccionario no oficial (omite el site.covid.dic para el de DGE)
  diccionario &lt;- descarga_diccionario(show_warnings = FALSE, site.covid.dic = diclink)

  # O bien descarga solo los datos abiertos de ejemplo desde Github
  # omite el dlink (o cámbialo por el vínculo correcto) para descargar los datos de la DGE
  datos_abiertos &lt;- descarga_db(sites.covid = dlink, show_warnings = FALSE)

  # Pegalos en el formato que se necesita para el resto de funciones
  datos_covid &lt;- pega_db_datos_abiertos_tbl_y_diccionario(datos_abiertos, diccionario)

  # Desconectamos
  datos_covid$disconnect()

  # Tambien puedes descargar paso por paso
  datos_abiertos &lt;- descarga_db_datos_abiertos_tbl(
    sites.covid = dlink,
    show_warnings = FALSE
  ) |&gt; # Descarga
  unzip_db_datos_abiertos_tbl() |&gt; # Unzippea
  parse_db_datos_abiertos_tbl() # Duckdb

  # O bien el diccionario
  diccionario &lt;- descarga_db_diccionario_ssa(site.covid.dic = diclink) |&gt; # Descarga
  unzip_db_diccionario_ssa() |&gt; # Unzippea
  parse_db_diccionario_ssa() # Tibble

  # Si descargaste cada uno por separado necesitas la funcion pega para
  # juntarlos en un unico objeto
  datos_covid &lt;- pega_db_datos_abiertos_tbl_y_diccionario(datos_abiertos, diccionario)
}

</code></pre>


</div>