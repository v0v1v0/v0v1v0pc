<div class="container">

<table style="width: 100%;"><tr>
<td>CBMSM</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Covariate Balancing Propensity Score (CBPS) for Marginal Structural Models</h2>

<h3>Description</h3>

<p><code>CBMSM</code> estimates propensity scores such that both covariate balance
and prediction of treatment assignment are maximized.  With longitudinal
data, the method returns marginal structural model weights that can be
entered directly into a linear model.  The method also handles multiple
binary treatments administered concurrently.
</p>


<h3>Usage</h3>

<pre><code class="language-R">CBMSM(
  formula,
  id,
  time,
  data,
  type = "MSM",
  twostep = TRUE,
  msm.variance = "approx",
  time.vary = FALSE,
  init = "opt",
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>A formula of the form treat ~ X.  The same covariates are used
in each time period.  At default values, a single set of coefficients is estimated
across all time periods.  To allow a different set of coefficients for each 
time period, set <code>time.vary = TRUE</code>.   Data should be sorted by time.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>id</code></td>
<td>
<p>A vector which identifies the unit associated with each row of
treat and X.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>time</code></td>
<td>
<p>A vector which identifies the time period associated with each
row of treat and X.  All data should be sorted by time.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>An optional data frame, list or environment (or object coercible
by as.data.frame to a data frame) containing the variables in the model. If
not found in data, the variables are taken from <code>environment(formula)</code>,
typically the environment from which <code>CBMSM</code> is called.  Data should be 
sorted by time.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>
<p>"MSM" for a marginal structural model, with multiple time
periods or "MultiBin" for multiple binary treatments at the same time
period.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>twostep</code></td>
<td>
<p>Set to <code>TRUE</code> to use a two-step estimator, which will
run substantially faster than continuous-updating.  Default is <code>FALSE</code>,
which uses the continuous-updating estimator described by Imai and Ratkovic
(2014).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>msm.variance</code></td>
<td>
<p>Default is <code>FALSE</code>, which uses the low-rank
approximation of the variance described in Imai and Ratkovic (2014).  Set to
<code>TRUE</code> to use the full variance matrix.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>time.vary</code></td>
<td>
<p>Default is <code>FALSE</code>, which uses the same coefficients
across time period.  Set to <code>TRUE</code> to fit one set per time period.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>init</code></td>
<td>
<p>Default is <code>"opt"</code>, which uses CBPS and logistic regression
starting values, and chooses the one that achieves the best balance.  Other options 
are "glm" and "CBPS"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Other parameters to be passed through to <code>optim()</code></p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>Fits covariate balancing propensity scores for marginal structural models.
</p>
<p>### @aliases CBMSM CBMSM.fit
</p>


<h3>Value</h3>

<table>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>
<p>The optimal weights.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fitted.values</code></td>
<td>
<p>The fitted
propensity score for each observation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y</code></td>
<td>
<p>The treatment vector used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>The covariate matrix.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>id</code></td>
<td>
<p>The vector id used in CBMSM.fit.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>time</code></td>
<td>
<p>The vector time used in CBMSM.fit.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>The model
frame.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>call</code></td>
<td>
<p>The matched call.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>The formula supplied.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>The data argument.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>treat.hist</code></td>
<td>
<p>A matrix of the treatment
history, with each observation in rows and time in columns.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>treat.cum</code></td>
<td>
<p>A vector of the cumulative treatment history, by
individual.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Marc Ratkovic, Christian Fong, and Kosuke Imai; The CBMSM function
is based on the code for version 2.15.0 of the glm function implemented in
the stats package, originally written by Simon Davies.  This documenation is
likewise modeled on the documentation for glm and borrows its language where
the arguments and values are the same.
</p>


<h3>References</h3>

<p>Imai, Kosuke and Marc Ratkovic.  2014. “Covariate Balancing Propensity
Score.” Journal of the Royal Statistical Society, Series B (Statistical
Methodology). <a href="http://imai.princeton.edu/research/CBPS.html">http://imai.princeton.edu/research/CBPS.html</a>
</p>
<p>Imai, Kosuke and Marc Ratkovic.  2015.  “Robust Estimation of Inverse
Probability Weights for Marginal Structural Models.” Journal of the
American Statistical Association.
<a href="http://imai.princeton.edu/research/MSM.html">http://imai.princeton.edu/research/MSM.html</a>
</p>


<h3>See Also</h3>

<p>plot.CBMSM
</p>


<h3>Examples</h3>

<pre><code class="language-R">

##Load Blackwell data

data(Blackwell)

## Quickly fit a short model to test
form0 &lt;- "d.gone.neg ~ d.gone.neg.l1 + camp.length"
fit0&lt;-CBMSM(formula = form0, time=Blackwell$time,id=Blackwell$demName,
			data=Blackwell, type="MSM",  iterations = NULL, twostep = TRUE, 
			msm.variance = "approx", time.vary = FALSE)

## Not run: 
##Fitting the models in Imai and Ratkovic  (2014)		
##Warning: may take a few mintues; setting time.vary to FALSE
##Results in a quicker fit but with poorer balance
##Usually, it is best to use time.vary TRUE
form1&lt;-"d.gone.neg ~ d.gone.neg.l1 + d.gone.neg.l2 + d.neg.frac.l3 + 
		camp.length + camp.length + deminc + base.poll + year.2002 + 
		year.2004 + year.2006 + base.und + office"

##Note that 	init="glm" gives the published results but the default is now init="opt"
fit1&lt;-CBMSM(formula = form1, time=Blackwell$time,id=Blackwell$demName,
			data=Blackwell, type="MSM",  iterations = NULL, twostep = TRUE, 
			msm.variance = "full", time.vary = TRUE, init="glm")

fit2&lt;-CBMSM(formula = form1, time=Blackwell$time,id=Blackwell$demName,
			data=Blackwell, type="MSM",  iterations = NULL, twostep = TRUE, 
			msm.variance = "approx", time.vary = TRUE, init="glm")


##Assessing balance

bal1&lt;-balance.CBMSM(fit1)
bal2&lt;-balance.CBMSM(fit2)

##Effect estimation: Replicating Effect Estimates in 
##Table 3 of Imai and Ratkovic (2014)

lm1&lt;-lm(demprcnt[time==1]~fit1$treat.hist,data=Blackwell,
weights=fit1$glm.weights)
lm2&lt;-lm(demprcnt[time==1]~fit1$treat.hist,data=Blackwell,
weights=fit1$weights)
lm3&lt;-lm(demprcnt[time==1]~fit1$treat.hist,data=Blackwell,
weights=fit2$weights)

lm4&lt;-lm(demprcnt[time==1]~fit1$treat.cum,data=Blackwell,
weights=fit1$glm.weights)
lm5&lt;-lm(demprcnt[time==1]~fit1$treat.cum,data=Blackwell,
weights=fit1$weights)
lm6&lt;-lm(demprcnt[time==1]~fit1$treat.cum,data=Blackwell,
weights=fit2$weights)



### Example: Multiple Binary Treatments Administered at the Same Time
n&lt;-200
k&lt;-4
set.seed(1040)
X1&lt;-cbind(1,matrix(rnorm(n*k),ncol=k))

betas.1&lt;-betas.2&lt;-betas.3&lt;-c(2,4,4,-4,3)/5
probs.1&lt;-probs.2&lt;-probs.3&lt;-(1+exp(-X1 %*% betas.1))^-1

treat.1&lt;-rbinom(n=length(probs.1),size=1,probs.1)
treat.2&lt;-rbinom(n=length(probs.2),size=1,probs.2)
treat.3&lt;-rbinom(n=length(probs.3),size=1,probs.3)
treat&lt;-c(treat.1,treat.2,treat.3)
X&lt;-rbind(X1,X1,X1)
time&lt;-c(rep(1,nrow(X1)),rep(2,nrow(X1)),rep(3,nrow(X1)))
id&lt;-c(rep(1:nrow(X1),3))
y&lt;-cbind(treat.1,treat.2,treat.3) %*% c(2,2,2) + 
X1 %*% c(-2,8,7,6,2) + rnorm(n,sd=5)

multibin1&lt;-CBMSM(treat~X,id=id,time=time,type="MultiBin",twostep=TRUE)
summary(lm(y~-1+treat.1+treat.2+treat.3+X1, weights=multibin1$w))

## End(Not run)

</code></pre>


</div>