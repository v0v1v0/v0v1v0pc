<div class="container">

<table style="width: 100%;"><tr>
<td>await</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Call a function repeatedly until a status is reached.</h2>

<h3>Description</h3>

<p><code>await</code> repeatedly calls a Civis API endpoint such as <code>scripts_get_sql_runs</code>
that monitors the status of a script, job, import, or model. It blocks until the function
returns a result with a successful or error status.
If the script, job, import or model results in an error state,
<code>await</code> throws an error with useful debugging information.
</p>
<p><code>await_all</code> is a vectorized version of <code>await</code>. It repeatedly calls a Civis API endpoint for
all values of a vector, e.g. a vector of script, job, import, run, or model ids. It blocks until
all calls have returned a result with a given status, and silently captures jobs that return
errors.
</p>


<h3>Usage</h3>

<pre><code class="language-R">await(
  f,
  ...,
  .status_key = "state",
  .success_states = c("succeeded", "success"),
  .error_states = c("failed", "cancelled"),
  .timeout = NULL,
  .interval = getOption("civis.default_polling_interval"),
  .verbose = FALSE
)

await_all(
  f,
  .x,
  .y = NULL,
  ...,
  .status_key = "state",
  .success_states = c("succeeded", "success"),
  .error_states = c("failed", "cancelled"),
  .timeout = NULL,
  .interval = NULL,
  .verbose = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>f</code></td>
<td>
<p>function to be called repeatedly until a status is reached.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>arguments to <code>f</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.status_key</code></td>
<td>
<p>The name of the element of the list returned by <code>f</code> containing the status.
For most Civis API endpoints, this is the default, <code>"state"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.success_states</code></td>
<td>
<p>list of states indicating remote work has completed successfully.
For most Civis API endpoints, this set of states is the default, <code>c("succeeded", "success")</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.error_states</code></td>
<td>
<p>list of states indicating remote work is in an error state. For most Civis
API endpoints, this set of states is the default, <code>c("failed", "cancelled")</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.timeout</code></td>
<td>
<p>Number of seconds after which to timeout.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.interval</code></td>
<td>
<p>The interval for retries (in seconds). If <code>NULL</code> (default), use exponentially increasing
intervals with jitter (see 'Details')</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.verbose</code></td>
<td>
<p>Print the status of <code>f</code> at a given retry with the retry time (default <code>FALSE</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.x</code></td>
<td>
<p>a vector of values to be passed to <code>f</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.y</code></td>
<td>
<p>a vector of values to be passed to <code>f</code> (default <code>NULL</code>)</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p><code>await</code> and <code>await_all</code> can wrap Civis API endpoints in <code>generated_client.R</code>.
The default values for <code>.status_key</code>, <code>.success_states</code>, and <code>.error_states</code>
are suitable for most endpoints. The final status of <code>f</code> can be obtained using
<code>get_status</code>.
</p>
<p>If an error state is reached, <code>await</code> throws a <code>civis_await_error</code>.
<code>await_all</code> silently captures and returns a <code>civis_await_error</code> for any job
reaching an error state as an element in the list of results.
</p>
<p>If <code>.timeout</code> is specified and the job fails to reach a success state
within the time limit, <code>await</code> throws a <code>civis_timeout_error</code>.
Likewise, <code>await_all</code> throws a <code>civis_timeout_error</code> if all jobs fail to
reach a success state within the time limit.
</p>
<p>These errors can be caught using <code>try</code> or <code>tryCatch</code>.
Useful debugging information can be returned using <code>get_error</code> and <code>fetch_logs</code>.
</p>
<p>The set of possible states for jobs on Civis platform are:
<code>"succeeded"</code>, <code>"success"</code>, <code>"failed"</code>, <code>"queued"</code>, <code>"running"</code>,
and <code>"cancelled"</code>.
</p>
<p>Unless <code>.interval</code> is specified, retries are attempted with exponentially increasing intervals using
<code>.25 * (1.2^i)) + runif(1, 0, .2)</code>, where <code>i</code> is the index of the current retry.
Approximate intervals for a given number of retries are as follows:
</p>

<ul>
<li>
<p>1-5: .5s
</p>
</li>
<li>
<p>6-10: 1-5s
</p>
</li>
<li>
<p>11-19: 5-10s
</p>
</li>
<li>
<p>20-29: 10s - 1m
</p>
</li>
</ul>
<p>The polling interval can be set to a fixed value globally with
<code>options("civis.default_polling_interval" = INTERVAL_IN_SECONDS)</code>.
</p>


<h3>Functions</h3>


<ul><li> <p><code>await_all()</code>: Call a function repeatedly for all values of a vector until all have reached a completed status
</p>
</li></ul>
<h3>See Also</h3>

<p><code>get_status, get_error, fetch_logs</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 

   # Executing a query
   q_id &lt;- queries_post(db_id, query, n_rows, cred_id)[["id"]]
   r &lt;- await(queries_get, id = q_id)
   get_status(r)

   r &lt;- tryCatch(await(queries_get, id = q_id), error = function(e) e)
   get_error(r)

   r &lt;- try(await(queries_get, id = q_id))
   get_error(r)

   jobs &lt;- c(1234, 5678)
   runs &lt;- c(1234, 5678)
   rs &lt;- await_all(scripts_get_r_runs, .x = jobs, .y = runs)

## End(Not run)
</code></pre>


</div>