<div class="container">

<table style="width: 100%;"><tr>
<td>read_datos_abiertos_zip</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Auxiliares de lectura para la base de la Direccion General de Epidemiologia</h2>

<h3>Description</h3>

<p>La funcion principal es <code>read_datos_abiertos()</code> la cual decide si los lee de <code>zip</code>,
<code>duckdb</code> o <code>csv</code> Tambien puedes usar las auxiliares respectivas
</p>

<ul>
<li> <p><code>read_datos_abiertos_zip()</code>     Si sólo descargaste los datos de la DGE en <code>.zip</code>
</p>
</li>
<li> <p><code>read_datos_abiertos_csv()</code>     Si descargaste los datos de la DGE en <code>.zip</code> y
los descomprimiste.
</p>
</li>
<li> <p><code>read_datos_abiertos_duckdb()</code>  Si ya creaste tu table en <code>duckdb</code>
</p>
</li>
</ul>
<h3>Usage</h3>

<pre><code class="language-R">read_datos_abiertos_zip(
  datos_abiertos_zip_paths,
  diccionario_zip_path = NULL,
  diccionario_unzipped_path = NULL,
  diccionario = NULL,
  read_format = c("duckdb", "tibble"),
  tblname = "covidmx",
  drv = duckdb::duckdb(),
  dbdir = tempfile(fileext = ".duckdb"),
  colClasses = get_col_class(),
  download_process = c("pins", "download.file"),
  site.covid.dic = paste0("http://datosabiertos.salud.", "gob.mx/gobmx/salud/datos_a",
    "biertos/diccionario_datos_", "covid19.zip"),
  unzip_command = Sys.getenv("unzip_command"),
  unzip_args = Sys.getenv("unzip_args"),
  unzip_args_dict = list(exdir = ".", overwrite = TRUE),
  check_unzip_install = TRUE,
  clear_zip = (download_process[1] != "pins"),
  clear_csv = TRUE,
  use_dict = TRUE,
  quiet = FALSE,
  cache_datos = NULL,
  use_cache_on_failure = TRUE,
  cache_diccionario = NULL,
  force_download = FALSE,
  show_warnings = TRUE,
  board_url_name = "datos_abiertos",
  board_url_name_dict = "diccionario_covid",
  download_file_args = list(method = "curl", destfile = tempfile(), quiet = quiet),
  descarga_db_diccionario_ssa_args = list(),
  ...
)

read_datos_abiertos_csv(
  datos_abiertos_unzipped_path,
  diccionario_zip_path = NULL,
  diccionario_unzipped_path = NULL,
  diccionario = NULL,
  read_format = c("duckdb", "tibble"),
  tblname = "covidmx",
  drv = duckdb::duckdb(),
  dbdir = tempfile(fileext = ".duckdb"),
  colClasses = get_col_class(),
  download_process = c("pins", "download.file"),
  site.covid.dic = paste0("http://datosabiertos.salud.", "gob.mx/gobmx/salud/datos_a",
    "biertos/diccionario_datos_", "covid19.zip"),
  unzip_args_dict = list(exdir = ".", overwrite = TRUE),
  clear_csv = TRUE,
  quiet = FALSE,
  use_cache_on_failure = TRUE,
  cache_diccionario = NULL,
  force_download = FALSE,
  show_warnings = TRUE,
  board_url_name_dict = "diccionario_covid",
  download_file_args = list(method = "curl", destfile = tempfile(), quiet = quiet),
  descarga_db_diccionario_ssa_args = list(),
  ...
)

read_datos_abiertos_duckdb(
  datos_abiertos_tbl,
  drv = duckdb::duckdb(),
  tblname = "covidmx",
  pragma_memory_limit = Sys.getenv("pragma_memory_limit"),
  diccionario_zip_path = NULL,
  diccionario_unzipped_path = NULL,
  diccionario = NULL,
  download_process = c("pins", "download.file"),
  site.covid.dic = paste0("http://datosabiertos.salud.", "gob.mx/gobmx/salud/datos_a",
    "biertos/diccionario_datos_", "covid19.zip"),
  unzip_args_dict = list(exdir = ".", overwrite = TRUE),
  clear_zip = download_process[1] != "pins",
  clear_csv = TRUE,
  use_dict = TRUE,
  quiet = FALSE,
  use_cache_on_failure = TRUE,
  cache_diccionario = NULL,
  force_download = FALSE,
  show_warnings = TRUE,
  board_url_name_dict = "diccionario_covid",
  download_file_args = list(method = "curl", destfile = tempfile(), quiet = quiet),
  descarga_db_diccionario_ssa_args = list(),
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>datos_abiertos_zip_paths</code></td>
<td>
<p>(<strong>opcional</strong>)  Camino a los datos abiertos si ya los
descargaste en <code>zip</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>diccionario_zip_path</code></td>
<td>
<p>(<strong>opcional</strong>)  Camino al diccionario si ya losdescargaste en <code>zip</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>diccionario_unzipped_path</code></td>
<td>
<p>(<strong>opcional</strong>)  Camino al diccionario <code>csv</code> si ya
lo descargaste y descomprimiste el archivo <code>zip</code> en un <code>csv</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>diccionario</code></td>
<td>
<p>(<strong>opcional</strong>)  Lo que resulta de realizar una descarga del diccionario
usando <code>descarga_diccionario</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>read_format</code></td>
<td>
<p>(<strong>opcional</strong>) <code>"duckdb"</code> o <code>"tibble"</code> establece el formato
de lectura de la base de datos. En la mayoria de los casos <code>"tibble"</code> va a
resultar en un error de memoria. La opcion de <code>"duckdb"</code> siempre es mas rapida por lo cual
es el default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tblname</code></td>
<td>
<p>(<strong>opcional</strong>)  Nombre de la tabla de <code>duckdb</code> donde guardar los datos por
default se llama <code>covidmx</code>. Solo es relevante si estas usando el mismo <code>dbdir</code> para otro
proyecto distinto.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>drv</code></td>
<td>
<p>(<strong>opcional</strong>) Un  driver para <code>dbConnect</code> (default <code>duckdb::duckdb()</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dbdir</code></td>
<td>
<p>(<strong>opcional</strong>) Direccion donde guardar la base de datos con terminacion <code>.duckdb</code>.
Corresponde al argumento de <code>duckdb::dbConnect__duckdb_driver()</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>colClasses</code></td>
<td>
<p>(<strong>opcional</strong>) Clases de la columna para leer en <code>duckdb::read_csv_duckdb()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>download_process</code></td>
<td>
<p>(<strong>opcional</strong>)  Metodo para descargar ya sea <code>pins</code> o <code>download.file</code>.
Se recomienda <code>pins</code> pues guarda en memoria la fecha de la ultima descarga y analiza
si ha pasado mas de un dia desde la descarga. En caso afirmativo verifica si el
archivo ha cambiado y si hubo cambios entonces lo descarga.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>site.covid.dic</code></td>
<td>
<p>(<strong>opcional</strong>)  Sitio desde el cual descarga del diccionario de datos.
La ultima verificacion del sitio fue el 6 de septiembre 2022.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>unzip_command</code></td>
<td>
<p>(<strong>opcional</strong>) Forma de extraer la base de datos de datos abiertos
si <code>unzip</code> falla.
La forma de llamarla es con <code>system2(unzip_command, args = c(unzip_args, file_download_data))</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>unzip_args</code></td>
<td>
<p>(<strong>opcional</strong>) Argumentos de extraccion de la base de datos de datos abiertos
si <code>unzip</code> falla.
La forma de llamarla es con <code>system2(unzip_command, args = c(unzip_args, file_download_data))</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>unzip_args_dict</code></td>
<td>
<p>(<strong>opcional</strong>) Lista de argumentos para usar <code>utils::unzip</code> en el
diccionario de datos.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>check_unzip_install</code></td>
<td>
<p>(<strong>opcional</strong>) Bandera de verificacion para checar si tienes
lo necesario para unzippear los datos en el caso de que <code>unzip</code> no sirva.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>clear_zip</code></td>
<td>
<p>(<strong>opcional</strong>) Si borrar los archivos <code>.zip</code> descargados para el diccionario
y los datos abiertos. No se recomienda si estas usando <code>pins</code>. Ve la nota para mas informacion.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>clear_csv</code></td>
<td>
<p>(<strong>opcional</strong>) Si borrar los archivos <code>.csv</code> que se generan despues de abrir
el zip. El default es que si pues en general solo requieres el <code>duckdb</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use_dict</code></td>
<td>
<p>(<strong>opcional</strong>) Si descargar el diccionario de <code>site.covid.dic</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quiet</code></td>
<td>
<p>(<strong>opcional</strong>) Variable para no mostrar mensajes</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cache_datos</code></td>
<td>
<p>(<strong>opcional</strong>) Direccion donde guardar los datos en memoria usando <code>pins</code>
para no tener que volver a descargarlos si nada ha cambiado</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use_cache_on_failure</code></td>
<td>
<p>(<strong>opcional</strong>) Booleana. Establece que si no se pueden descargar
datos nuevos utilice los que tenga en memoria. Por default es <code>TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cache_diccionario</code></td>
<td>
<p>(<strong>opcional</strong>) Direccion donde guardar el diccionario en memoria
usando <code>pins</code> para no tener que volver a descargarlo si nada ha cambiado</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>force_download</code></td>
<td>
<p>(<strong>opcional</strong>) Analiza si cambio el pin y descarga datos nuevos en caso
afirmativo aunque haya pasado menos de un dia.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>show_warnings</code></td>
<td>
<p>(<strong>opcional</strong>) si arrojar <code>warnings</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>board_url_name</code></td>
<td>
<p>(<strong>opcional</strong>) Establece el nombre del <code>pins::board_url</code> para
los datos abiertos (si ya usas pins para que no se empalme).
Por default se llama <code>datos_abiertos</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>board_url_name_dict</code></td>
<td>
<p>(<strong>opcional</strong>) Establece el nombre del <code>pins::board_url</code> para los
datos abiertos. Por default se llama <code>diccionario_covid</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>download_file_args</code></td>
<td>
<p>(<strong>opcional</strong>) Lista de argumentos adicionales para <code>download.file</code>
de los datos si se elige este metodo para descargar.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>descarga_db_diccionario_ssa_args</code></td>
<td>
<p>(<strong>opcional</strong>) Lista con argumentos adicionales para el
<code>pins::pin_download</code> de datos abiertos</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>(<strong>opcional</strong>) Parametros adicionales para <code>DBI::dbConnect</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>datos_abiertos_unzipped_path</code></td>
<td>
<p>(<strong>opcional</strong>)  Camino a los datos abiertos <code>csv</code> si ya
los descargaste y descomprimiste el archivo <code>zip</code> en un <code>csv</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>datos_abiertos_tbl</code></td>
<td>
<p>(<strong>opcional</strong>) Camino a un archivo <code>.duckdb</code> con los datos formateados</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pragma_memory_limit</code></td>
<td>
<p>(<strong>opcional</strong>) Limite de memoria para el programa
(ver <a href="https://duckdb.org/docs/sql/pragmas">PRAGMAS</a>). Cambialo a que sea mas o menos la mitad
de tu RAM. La forma mas sencilla es como una variable ambiental con
<code>Sys.setenv('pragma_memory_limit' = '1GB')</code> por ejemplo para un limite de 1 gigabyte.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>Lista de valores:
</p>

<ul>
<li>
<p> dats        - Tabla conectada mediante <code>DBI::dbConnect</code> (si <code>duckdb</code>) o
tibble (si <code>tibble</code>)
</p>
</li>
<li>
<p> disconnect  - Funcion para cerrar la conexion a la base de datos.
</p>
</li>
<li>
<p> dict        - Lista de <code>tibble</code>s con el diccionario de datos para cada variable
</p>
</li>
</ul>
<h3>Note</h3>

<p>Para guardar tu base con <code>duckdb</code> cambia el <code>dbdir</code> a un archivo <code>.duckdb</code>. Como ejemplo
<code>dbdir = "ejemplo.duckdb"</code>.
</p>


<h3>Examples</h3>

<pre><code class="language-R">
# Lee los datos de duckdb una vez descargados
# quita la opción de sites.covid para descargar los de la DGE. 
# Esto es solo un ejemplo.
file_ejemplo &lt;- tempfile(fileext = ".duckdb")

#Estos links deben omitirse en una corrida normal. Se incluyen por ahora como ejemplo
#pero las opciones site.covid.dic y sites.covid deben eliminarse de abajo.
dlink        &lt;- "https://github.com/RodrigoZepeda/covidmx/raw/main/datos_abiertos_covid19.zip"
diclink      &lt;- "https://github.com/RodrigoZepeda/covidmx/raw/main/diccionario_datos_covid19.zip"

#En el ejemplo de R por normas de CRAN tenemos que hacerlo así pero en tu
#computadora puedes solo usar descargar datos sin el if else
if (RCurl::url.exists(dlink) &amp; RCurl::url.exists(diclink)){

  #Necesitamos la base para verificar los reads
  datos_covid &lt;- descarga_datos_abiertos(
    dbdir = file_ejemplo,
    sites.covid = dlink, 
    site.covid.dic = diclink,
    show_warnings = FALSE
  )
  datos_covid$disconnect()
  
  datos_covid &lt;- read_datos_abiertos(file_ejemplo, show_warnings = FALSE, 
                    site.covid.dic = diclink)
  datos_covid$disconnect()

   # Es lo mismo que:
  datos_covid &lt;- read_datos_abiertos_duckdb(file_ejemplo, show_warnings = FALSE,
                                            site.covid.dic = diclink)
  datos_covid$disconnect()

  # Descarga los datos y lee de un zip guardandolos a la vez en
  # base de nombre datos_desde_zip.duckdb
  direccion_zip &lt;- descarga_db_datos_abiertos_tbl(sites.covid = dlink, show_warnings = FALSE,
                                                  site.covid.dic = diclink)
                                                 
  datos_covid &lt;- read_datos_abiertos(direccion_zip,
    dbdir = file_ejemplo,
    site.covid.dic = diclink,
    show_warnings = FALSE
  )
  datos_covid$disconnect()

  # Es lo mismo que:
  datos_covid &lt;- read_datos_abiertos_zip(direccion_zip,
    site.covid.dic = diclink,
    dbdir = file_ejemplo,
    show_warnings = FALSE
  )
  datos_covid$disconnect()

  # Descarga los datos y lee de un csv
  direccion_zip &lt;- descarga_db_datos_abiertos_tbl(sites.covid = dlink, show_warnings = FALSE)
  direccion_csv &lt;- unzip_db_datos_abiertos_tbl(direccion_zip)
  datos_covid   &lt;- read_datos_abiertos(direccion_csv, show_warnings = FALSE, 
                                          site.covid.dic = diclink)
  datos_covid$disconnect()

  # Es lo mismo que:
  direccion_csv &lt;- unzip_db_datos_abiertos_tbl(direccion_zip)
  datos_covid   &lt;- read_datos_abiertos_csv(direccion_csv, show_warnings = FALSE,
                          site.covid.dic = diclink)
  datos_covid$disconnect()
}

</code></pre>


</div>